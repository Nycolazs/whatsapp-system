<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - WhatsApp System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      background: #00a884;
      color: white;
    }

    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .nav-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: center;
      color: #667781;
      font-size: 14px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: #f5f5f5;
    }

    .nav-item.active {
      background: #e9f7f3;
      color: #00a884;
      border-right: 3px solid #00a884;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .back-btn {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #5568d3;
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #ff5252;
    }

    .whatsapp-logout-btn {
      width: 100%;
      padding: 10px;
      background: #ffb020;
      color: #111;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .whatsapp-logout-btn:hover {
      background: #f59e0b;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      color: #111;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
    }

    /* Sellers View */
    .sellers-container {
      display: none;
    }

    .sellers-container.active {
      display: block;
    }

    .btn-new-seller {
      background: #00a884;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-new-seller:hover {
      background: #008f6c;
    }

    .sellers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .seller-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s;
    }

    .seller-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .seller-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .seller-name {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .seller-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .seller-info {
      color: #667781;
      font-size: 13px;
      margin-bottom: 15px;
    }

    .seller-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .btn-edit {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #ff6b6b;
      color: white;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    /* Tickets View */
    .tickets-container {
      display: none;
    }

    .tickets-container.active {
      display: block;
    }

    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tickets-table th {
      padding: 15px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-weight: 600;
      color: #111;
      font-size: 13px;
    }

    .tickets-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }

    .tickets-table tr:hover {
      background: #fafafa;
    }

    .ticket-phone {
      font-weight: 600;
      color: #111;
    }

    .ticket-seller {
      color: #667781;
    }

    .ticket-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pendente {
      background: #fff3cd;
      color: #856404;
    }

    .status-em_atendimento {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-resolvido {
      background: #d4edda;
      color: #155724;
    }

    .assign-select {
      padding: 6px 10px;
      border: 1px solid #d1d7db;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Business Hours */
    .hours-container {
      display: none;
    }

    .hours-container.active {
      display: block;
    }

    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .panel h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #111;
    }

    .hours-grid {
      display: grid;
      gap: 12px;
    }

    .hours-row {
      display: grid;
      grid-template-columns: 1fr 120px 120px 120px;
      gap: 10px;
      align-items: center;
    }

    .hours-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #111;
    }

    .hours-row input[type="time"] {
      padding: 8px 10px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
    }

    .hours-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .btn-save-hours {
      padding: 10px 16px;
      background: #00a884;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-save-hours:hover {
      background: #008f6c;
    }

    .exceptions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .exceptions-table th,
    .exceptions-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .exceptions-table th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .exception-form {
      display: grid;
      grid-template-columns: 180px 1fr 140px;
      gap: 10px;
      align-items: center;
    }

    .exception-form input,
    .exception-form button,
    .exception-form textarea {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
    }

    .exception-form button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .exception-form button:hover {
      background: #5568d3;
    }

    .btn-delete-exception {
      padding: 6px 12px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .message-textarea {
      width: 100%;
      min-height: 90px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    /* Blacklist */
    .blacklist-container {
      display: none;
    }

    .blacklist-container.active {
      display: block;
    }

    .blacklist-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .blacklist-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .blacklist-form textarea,
    .blacklist-form input {
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .blacklist-form textarea {
      grid-column: 1 / -1;
      min-height: 80px;
      resize: vertical;
    }

    .blacklist-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #111;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .blacklist-table {
      width: 100%;
      border-collapse: collapse;
    }

    .blacklist-table th,
    .blacklist-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Toast de Alerta */
    .custom-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      max-width: 350px;
      border-left: 4px solid #00a884;
    }

    .custom-toast.error {
      border-left-color: #ff6b6b;
    }

    .custom-toast.warning {
      border-left-color: #ffa500;
    }

    .custom-toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .custom-toast-message {
      flex: 1;
      font-size: 14px;
      color: #111;
    }

    .custom-toast-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #667781;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .custom-toast.hiding {
      animation: slideOutRight 0.3s ease;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #111;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .btn-save {
      background: #667eea;
      color: white;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #111;
    }

    .btn-modal:hover {
      opacity: 0.8;
    }

    /* Responsividade Mobile */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        max-height: 50vh;
      }

      .main-content {
        width: 100%;
        padding: 15px;
      }

      .content-header h1 {
        font-size: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .sellers-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px 6px;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .sidebar-header {
        padding: 15px;
      }

      .sidebar-header h2 {
        font-size: 18px;
      }

      .main-content {
        padding: 10px;
      }

      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Admin</h2>
        <p style="font-size: 12px; opacity: 0.9;" id="adminName">Admin</p>
      </div>

      <div class="sidebar-nav">
        <div class="nav-item active" data-section="sellers" onclick="showSection('sellers')">
          <span>ÔøΩ</span>
          Usu√°rios
        </div>
        <div class="nav-item" data-section="tickets" onclick="showSection('tickets')">
          <span>üìã</span>
          Tickets
        </div>
        <div class="nav-item" data-section="blacklist" onclick="showSection('blacklist')">
          <span>üö´</span>
          Blacklist
        </div>
        <div class="nav-item" data-section="hours" onclick="showSection('hours')">
          <span>üóìÔ∏è</span>
          Hor√°rios de Funcionamento
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="back-btn" onclick="goBackToChats()">‚Üê Voltar aos Chats</button>
        <button class="whatsapp-logout-btn" onclick="disconnectWhatsApp()">Desconectar WhatsApp</button>
        <button class="logout-btn" onclick="logout()">Sair</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1 id="sectionTitle">Gerenciar Vendedores</h1>
        <button id="headerBtn" class="btn-new-seller" onclick="openNewSellerModal()">+ Novo Usu√°rio</button>
      </div>

      <div class="content">
        <!-- Sellers Section -->
        <div class="sellers-container active" id="sellersSection">
          <div id="sellersList"></div>
        </div>

        <!-- Tickets Section -->
        <div class="tickets-container" id="ticketsSection">
          <table class="tickets-table">
            <thead>
              <tr>
                <th>Contato</th>
                <th>Telefone</th>
                <th>Vendedor</th>
                <th>Status</th>
                <th>Atualizado em</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="ticketsTableBody">
            </tbody>
          </table>
        </div>

        <!-- Blacklist Section -->
        <div class="blacklist-container" id="blacklistSection">
          <div class="blacklist-grid">
            <div class="panel">
              <h3>Adicionar n√∫mero</h3>
              <form id="blacklistForm" class="blacklist-form" onsubmit="addBlacklist(event)">
                <input type="text" id="blacklistPhone" placeholder="Ex: 5511999999999@s.whatsapp.net ou 5511999999999" required>
                <input type="text" id="blacklistReason" placeholder="Motivo (opcional)">
                <textarea id="blacklistReasonDetails" placeholder="Detalhes adicionais (opcional)"></textarea>
                <div class="blacklist-actions">
                  <button class="btn-primary" type="submit">Adicionar</button>
                  <button class="btn-secondary" type="reset">Limpar</button>
                </div>
              </form>
            </div>

            <div class="panel">
              <h3>Lista de n√∫meros bloqueados</h3>
              <table class="blacklist-table">
                <thead>
                  <tr>
                    <th>Telefone</th>
                    <th>Motivo</th>
                    <th>Adicionado em</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="blacklistTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Business Hours Section -->
        <div class="hours-container" id="hoursSection">
          <div class="panel">
            <h3>Mensagem autom√°tica fora do hor√°rio</h3>
            <textarea id="outOfHoursMessage" class="message-textarea" placeholder="Digite a mensagem autom√°tica..."></textarea>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveOutOfHoursMessage()">Salvar mensagem</button>
            </div>
          </div>

          <div class="panel">
            <h3>Hor√°rios por dia</h3>
            <div class="hours-grid" id="hoursGrid"></div>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveBusinessHours()">Salvar hor√°rios</button>
            </div>
          </div>

          <div class="panel">
            <h3>Datas de exce√ß√£o (feriados)</h3>
            <div class="exception-form">
              <input type="date" id="exceptionDate">
              <input type="text" id="exceptionReason" placeholder="Motivo (ex: feriado)">
              <button onclick="addException()">Adicionar</button>
            </div>
            <table class="exceptions-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Motivo</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="exceptionsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para criar/editar vendedor -->
  <div class="modal" id="sellerModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Novo Usu√°rio</div>
      
      <form id="sellerForm" onsubmit="saveSeller(event)">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="sellerName" required>
        </div>

        <div class="form-group">
          <label>Senha *</label>
          <input type="password" id="sellerPassword" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-modal btn-cancel" onclick="closeSellerModal()">Cancelar</button>
          <button type="submit" class="btn-modal btn-save">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header" id="confirmTitle">Confirmar a√ß√£o</div>
      <p id="confirmMessage" style="margin-bottom: 20px; color: #667781; font-size: 14px;"></p>
      <div class="modal-actions">
        <button type="button" class="btn-modal btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
        <button type="button" class="btn-modal btn-save" onclick="confirmModalAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = `http://${window.location.hostname}:3001`;
    let sellers = [];
    let tickets = [];
    let editingId = null;
    let businessHours = [];
    let exceptions = [];
    const DAYS = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    let blacklist = [];
    let confirmCallback = null;

    // Verificar autentica√ß√£o via sess√£o
    async function checkAuth() {
      try {
        const response = await fetch(`${API_URL}/auth/session`, {
          credentials: 'include'
        });

        if (!response.ok) {
          window.location.href = '/login';
          return;
        }

        const data = await response.json();
        
        if (data.userType !== 'admin') {
          window.location.href = '/login';
          return;
        }

        document.getElementById('adminName').textContent = data.userName;
      } catch (error) {
        window.location.href = '/login';
      }
    }

    async function disconnectWhatsApp() {
      openConfirmModal('Desconectar WhatsApp? Isso vai limpar os dados do atendimento.', async () => {
        try {
          await fetch(`${API_URL}/whatsapp/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          // Ignora
        }

        try {
          await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          // Ignora
        }

        window.location.href = '/whatsapp-qr';
      });
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        // Ignora erros de logout
      }
      window.location.href = '/login';
    }

    function showSection(section) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === section);
      });
      
      document.querySelectorAll('[id$="Section"]').forEach(div => {
        div.classList.remove('active');
      });

      if (section === 'sellers') {
        document.getElementById('sellersSection').classList.add('active');
        document.getElementById('sectionTitle').textContent = 'Gerenciar Usu√°rios';
        document.getElementById('headerBtn').style.display = 'block';
        document.getElementById('headerBtn').textContent = '+ Novo Usu√°rio';
        document.getElementById('headerBtn').onclick = openNewSellerModal;
        loadUsers();
      } else if (section === 'tickets') {
        document.getElementById('ticketsSection').classList.add('active');
        document.getElementById('sectionTitle').textContent = 'Tickets';
        document.getElementById('headerBtn').style.display = 'none';
        loadTickets();
      } else if (section === 'blacklist') {
        document.getElementById('blacklistSection').classList.add('active');
        document.getElementById('sectionTitle').textContent = 'Blacklist';
        document.getElementById('headerBtn').style.display = 'none';
        loadBlacklist();
      } else if (section === 'hours') {
        document.getElementById('hoursSection').classList.add('active');
        document.getElementById('sectionTitle').textContent = 'Hor√°rios de Funcionamento';
        document.getElementById('headerBtn').style.display = 'none';
        loadBusinessHours();
        loadExceptions();
        loadOutOfHoursMessage();
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/users`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.error('Erro ao carregar usu√°rios:', response.status);
          showToast('Erro ao carregar usu√°rios', 'error');
          return;
        }
        
        sellers = await response.json();
        renderUsers();
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        showToast('Erro ao carregar usu√°rios', 'error');
      }
    }

    function renderUsers() {
      const container = document.getElementById('sellersList');
      
      if (sellers.length === 0) {
        container.innerHTML = '<p style="color: #667781; text-align: center;">Nenhum usu√°rio cadastrado</p>';
        return;
      }

      container.innerHTML = sellers.map(user => {
        const type = [];
        if (user.isAdmin) type.push('üëë Admin');
        if (user.isSeller) type.push('üë®‚Äçüíº Vendedor');
        const typeText = type.length > 0 ? type.join(' ‚Ä¢ ') : 'Sem papel';
        
        return `
        <div class="seller-card">
          <div class="seller-header">
            <div class="seller-name">${user.name}</div>
            <div class="seller-status ${(user.isAdmin || (user.isSeller && user.sellerActive)) ? 'status-active' : 'status-inactive'}">
              ${typeText}
            </div>
          </div>
          <div class="seller-info">
            Criado em: ${new Date(user.created_at).toLocaleDateString('pt-BR')}
          </div>
          <div class="seller-actions">
            ${!user.isAdmin ? `<button class="btn-small btn-edit" onclick="makeAdminUser('${user.name}')">üëë Fazer Admin</button>` : ''}
            ${user.isAdmin && !user.isSeller ? `<button class="btn-small btn-edit" onclick="makeSellerAdmin('${user.name}')">üë®‚Äçüíº Fazer Vendedor</button>` : ''}
            ${user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerAdmin('${user.name}')">‚ùå Remover Vendedor</button>` : ''}
            ${!user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerOnly(${user.id || 'null'}, '${user.name}')">‚ùå Remover</button>` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    async function loadTickets() {
      try {
        const response = await fetch(`${API_URL}/admin/tickets`, {
          credentials: 'include'
        });
        tickets = await response.json();
        renderTickets();
      } catch (error) {
        // Erro ao carregar tickets
      }
    }

    function renderTickets() {
      const tbody = document.getElementById('ticketsTableBody');
      
      if (tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #667781;">Nenhum ticket</td></tr>';
        return;
      }

      tbody.innerHTML = tickets.map(ticket => `
        <tr>
          <td>${ticket.contact_name || '-'}</td>
          <td class="ticket-phone">${ticket.phone}</td>
          <td class="ticket-seller">${ticket.seller_name || 'N√£o atribu√≠do'}</td>
          <td><span class="ticket-status status-${ticket.status}">${ticket.status.replace('_', ' ')}</span></td>
          <td>${new Date(ticket.updated_at).toLocaleDateString('pt-BR')}</td>
          <td>
            <select class="assign-select" onchange="assignTicket(${ticket.id}, this.value)">
              <option value="">Atribuir...</option>
              <option value="0" ${!ticket.seller_id ? 'selected' : ''}>N√£o atribu√≠do</option>
              ${sellers.map(s => `<option value="${s.id}" ${ticket.seller_id === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </td>
        </tr>
      `).join('');
    }

    async function loadBusinessHours() {
      try {
        const response = await fetch(`${API_URL}/business-hours`, {
          credentials: 'include'
        });
        businessHours = await response.json();
        renderBusinessHours();
      } catch (error) {
        // Erro ao carregar hor√°rios
      }
    }

    function renderBusinessHours() {
      const grid = document.getElementById('hoursGrid');
      const ordered = [...businessHours].sort((a, b) => a.day - b.day);

      if (!ordered.length) {
        grid.innerHTML = '<p style="color: #667781;">Nenhum hor√°rio configurado.</p>';
        return;
      }

      grid.innerHTML = ordered.map(item => `
        <div class="hours-row">
          <div>${DAYS[item.day]}</div>
          <label>
            <input type="checkbox" class="hours-enabled" data-day="${item.day}" ${item.enabled ? 'checked' : ''}>
            Aberto
          </label>
          <input type="time" data-day="${item.day}" data-field="open_time" value="${item.open_time || ''}">
          <input type="time" data-day="${item.day}" data-field="close_time" value="${item.close_time || ''}">
        </div>
      `).join('');

      document.querySelectorAll('.hours-enabled').forEach(cb => {
        const day = cb.dataset.day;
        const inputs = document.querySelectorAll(`input[data-day="${day}"][data-field]`);
        inputs.forEach(input => {
          input.disabled = !cb.checked;
        });
        cb.addEventListener('change', () => {
          inputs.forEach(input => {
            input.disabled = !cb.checked;
          });
        });
      });
    }

    async function saveBusinessHours() {
      try {
        const hours = DAYS.map((_, day) => {
          const enabled = document.querySelector(`.hours-enabled[data-day="${day}"]`)?.checked;
          const open = document.querySelector(`input[data-day="${day}"][data-field="open_time"]`)?.value;
          const close = document.querySelector(`input[data-day="${day}"][data-field="close_time"]`)?.value;
          return {
            day,
            enabled: !!enabled,
            open_time: open || null,
            close_time: close || null
          };
        });

        const response = await fetch(`${API_URL}/business-hours`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ hours })
        });

        if (!response.ok) throw new Error('Erro ao salvar hor√°rios');
        showToast('Hor√°rios atualizados', 'success');
        loadBusinessHours();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function loadExceptions() {
      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          credentials: 'include'
        });
        exceptions = await response.json();
        renderExceptions();
      } catch (error) {
        // Erro ao carregar exce√ß√µes
      }
    }

    async function loadBlacklist() {
      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          credentials: 'include'
        });
        blacklist = await response.json();
        renderBlacklist();
      } catch (error) {
        showToast('Erro ao carregar blacklist', 'error');
      }
    }

    function renderBlacklist() {
      const tbody = document.getElementById('blacklistTableBody');
      if (!Array.isArray(blacklist) || blacklist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #667781;">Nenhum n√∫mero bloqueado</td></tr>';
        return;
      }

      tbody.innerHTML = blacklist.map(item => `
        <tr>
          <td>${item.phone}</td>
          <td>${item.reason || '‚Äî'}</td>
          <td>${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
          <td><button class="btn-danger" onclick="removeBlacklist('${item.phone}')">Remover</button></td>
        </tr>
      `).join('');
    }

    async function addBlacklist(event) {
      event.preventDefault();

      let phone = document.getElementById('blacklistPhone').value.trim();
      const reason = document.getElementById('blacklistReason').value.trim();
      const details = document.getElementById('blacklistReasonDetails').value.trim();
      const fullReason = [reason, details].filter(Boolean).join(' - ');

      if (!phone.includes('@')) {
        phone = phone.replace(/\D/g, '') + '@s.whatsapp.net';
      }

      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ phone, reason: fullReason })
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Erro ao adicionar');
        }

        showToast('N√∫mero adicionado com sucesso', 'success');
        document.getElementById('blacklistForm').reset();
        loadBlacklist();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function removeBlacklist(phone) {
      openConfirmModal(`Remover ${phone} da blacklist?`, async () => {
        try {
          const response = await fetch(`${API_URL}/blacklist/${encodeURIComponent(phone)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'Erro ao remover');
          }

          showToast('N√∫mero removido com sucesso', 'success');
          loadBlacklist();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    function formatDateBR(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(`${dateStr}T00:00:00`);
      return date.toLocaleDateString('pt-BR');
    }

    function renderExceptions() {
      const tbody = document.getElementById('exceptionsTableBody');
      if (!exceptions.length) {
        tbody.innerHTML = '<tr><td colspan="3" style="color: #667781; text-align: center;">Nenhuma exce√ß√£o cadastrada</td></tr>';
        return;
      }

      tbody.innerHTML = exceptions.map(ex => `
        <tr>
          <td>${formatDateBR(ex.date)}</td>
          <td>${ex.reason || '-'}</td>
          <td><button class="btn-delete-exception" onclick="deleteException(${ex.id})">Remover</button></td>
        </tr>
      `).join('');
    }

    async function addException() {
      const date = document.getElementById('exceptionDate').value;
      const reason = document.getElementById('exceptionReason').value;

      if (!date) {
        showToast('Informe uma data', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ date, closed: true, reason })
        });

        if (!response.ok) throw new Error('Erro ao salvar exce√ß√£o');

        document.getElementById('exceptionDate').value = '';
        document.getElementById('exceptionReason').value = '';
        loadExceptions();
        showToast('Exce√ß√£o adicionada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteException(id) {
      openConfirmModal('Remover esta exce√ß√£o?', async () => {
        try {
          const response = await fetch(`${API_URL}/business-exceptions/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover exce√ß√£o');
          loadExceptions();
          showToast('Exce√ß√£o removida', 'success');
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function loadOutOfHoursMessage() {
      try {
        const response = await fetch(`${API_URL}/business-message`, {
          credentials: 'include'
        });
        const data = await response.json();
        document.getElementById('outOfHoursMessage').value = data.message || '';
      } catch (error) {
        // Erro ao carregar mensagem
      }
    }

    async function saveOutOfHoursMessage() {
      const message = document.getElementById('outOfHoursMessage').value.trim();
      if (!message) {
        showToast('Digite uma mensagem', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-message`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ message })
        });

        if (!response.ok) throw new Error('Erro ao salvar mensagem');
        showToast('Mensagem atualizada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function openNewSellerModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
      document.getElementById('sellerName').value = '';
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = true;
      document.getElementById('sellerModal').classList.add('active');
    }

    function editSeller(id, name) {
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Editar Vendedor';
      document.getElementById('sellerName').value = name;
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = false;
      document.getElementById('sellerPassword').placeholder = 'Deixar em branco para manter a senha atual';
      document.getElementById('sellerModal').classList.add('active');
    }

    function closeSellerModal() {
      document.getElementById('sellerModal').classList.remove('active');
    }

    function openConfirmModal(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = onConfirm;
      document.getElementById('confirmModal').classList.add('active');
    }

    function closeConfirmModal() {
      confirmCallback = null;
      document.getElementById('confirmModal').classList.remove('active');
    }

    function confirmModalAction() {
      if (typeof confirmCallback === 'function') {
        confirmCallback();
      }
      closeConfirmModal();
    }

    async function saveSeller(event) {
      event.preventDefault();
      
      const name = document.getElementById('sellerName').value;
      const password = document.getElementById('sellerPassword').value;

      try {
        if (editingId) {
          const data = { name };
          if (password) data.password = password;
          
          const response = await fetch(`${API_URL}/sellers/${editingId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          if (!response.ok) throw new Error('Erro ao atualizar');
          showToast('Vendedor atualizado com sucesso', 'success');
        } else {
          if (!password) {
            showToast('Senha √© obrigat√≥ria para Novo Usu√°rio', 'warning');
            return;
          }

          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Erro ao criar');
          }
          showToast('Vendedor criado com sucesso', 'success');
        }

        closeSellerModal();
        loadUsers();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteSeller(id, name) {
      openConfirmModal(`Tem certeza que deseja deletar este vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao deletar');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminSeller(id, name) {
      openConfirmModal(`Tornar ${name} admin? Ele ter√° acesso total ao sistema.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao tornar admin');
          showToast('Admin criado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeAdminSeller(id, name) {
      openConfirmModal(`Remover status de admin de ${name}? Ele continuar√° como vendedor.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}/remove-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover admin');
          showToast('Admin removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminUser(name) {
      openConfirmModal(`Tornar ${name} admin? Ele ter√° acesso total ao sistema.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password: Math.random().toString(36).slice(2) })
          });

          if (!response.ok) throw new Error('Erro ao criar vendedor');
          
          const seller = await response.json();
          
          const response2 = await fetch(`${API_URL}/sellers/${seller.id}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response2.ok) throw new Error('Erro ao tornar admin');
          showToast('Admin criado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeSellerAdmin(name) {
      openConfirmModal(`Fazer ${name} tamb√©m ser vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${name}/make-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao tornar vendedor');
          showToast('Vendedor adicionado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerAdmin(name) {
      openConfirmModal(`Remover ${name} de vendedor? Ele continuar√° como admin.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${name}/remove-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover vendedor');
          showToast('Vendedor removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerOnly(id, name) {
      openConfirmModal(`Deletar vendedor ${name}?`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${id}/remove-seller-only`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao deletar');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function assignTicket(ticketId, sellerId) {
      try {
        const response = await fetch(`${API_URL}/tickets/${ticketId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sellerId: sellerId || null })
        });

        if (!response.ok) throw new Error('Erro ao atribuir');
        showToast('Ticket atribu√≠do com sucesso', 'success');
        loadTickets();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function goBackToChats() {
      window.location.href = '/agent';
    }

    // Sistema de Toast customizado
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `custom-toast ${type}`;

      const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
      toast.innerHTML = `
        <div class="custom-toast-icon">${icon}</div>
        <div class="custom-toast-message">${message}</div>
        <button class="custom-toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Inicializar
    checkAuth();
    showSection('sellers');
  </script>
</body>
</html>
