<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    if (window.location.protocol === 'https:') {
      window.location.replace(`http://${window.location.host}${window.location.pathname}${window.location.search}${window.location.hash}`);
    }
  </script>
  <title>Admin - WhatsApp System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar-overlay {
      display: none;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      background: #00a884;
      color: white;
    }

    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .nav-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: center;
      color: #667781;
      font-size: 14px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: #f5f5f5;
    }

    .nav-item.active {
      background: #e9f7f3;
      color: #00a884;
      border-right: 3px solid #00a884;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .back-btn {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #5568d3;
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #ff5252;
    }

    .whatsapp-logout-btn {
      width: 100%;
      padding: 10px;
      background: #ffb020;
      color: #111;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .whatsapp-logout-btn:hover {
      background: #f59e0b;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .header {
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      background: #fff;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #111;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-btn:active {
      transform: scale(0.98);
    }

    .header h1 {
      font-size: 24px;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      -webkit-overflow-scrolling: touch;
    }

    .hidden {
      opacity: 0 !important;
      transform: translateY(8px) !important;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }

    /* Section panels: animate visibility smoothly */
    .sellers-container,
    .tickets-container,
    .blacklist-container,
    .hours-container,
    .await-container {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform: translateY(8px);
      transition: opacity 280ms cubic-bezier(.2,.9,.2,1), transform 280ms cubic-bezier(.2,.9,.2,1), max-height 420ms ease;
      visibility: hidden;
    }

    .sellers-container.active,
    .tickets-container.active,
    .blacklist-container.active,
    .hours-container.active,
    .await-container.active {
      opacity: 1;
      max-height: 2000px; /* large enough to show content */
      transform: none;
      visibility: visible;
    }

    .btn-new-seller {
      background: #00a884;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-new-seller:hover {
      background: #008f6c;
    }

    .sellers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .seller-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s;
    }

    .seller-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .seller-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .seller-name {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .seller-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .seller-info {
      color: #667781;
      font-size: 13px;
      margin-bottom: 15px;
    }

    .seller-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .btn-edit {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #ff6b6b;
      color: white;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    /* Tickets View */
    .tickets-container {
      display: none;
    }

    .tickets-container.active {
      display: block;
    }

    .tickets-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 12px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 190px;
    }

    .filter-group label {
      font-size: 12px;
      color: #667781;
      font-weight: 600;
    }

    .filter-control {
      padding: 8px 10px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      font-family: inherit;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.5px;
    }

    .filter-control::placeholder {
      color: #bbb;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .filter-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .filter-inline .filter-control {
      flex: 1 1 0;
      min-width: 0;
      width: auto;
    }

    .filter-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tickets-table th {
      padding: 15px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-weight: 600;
      color: #111;
      font-size: 13px;
    }

    .tickets-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }

    .tickets-table tr:hover {
      background: #fafafa;
    }

    .ticket-phone {
      font-weight: 600;
      color: #111;
    }

    .ticket-seller {
      color: #667781;
    }

    .ticket-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pendente {
      background: #fff3cd;
      color: #856404;
    }

    .status-em_atendimento {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-resolvido {
      background: #d4edda;
      color: #155724;
    }
    .status-encerrado {
      background: #d4edda;
      color: #155724;
    }
    .status-aguardando {
      background: #fff0e0;
      color: #7a4b00;
    }

    .assign-select {
      padding: 6px 10px;
      border: 1px solid #d1d7db;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Business Hours */
    .hours-container {
      display: none;
    }

    .hours-container.active {
      display: block;
    }

    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .panel h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #111;
    }

    .hours-grid {
      display: grid;
      gap: 12px;
    }

    .hours-row {
      display: grid;
      grid-template-columns: 1fr 120px 120px 120px;
      gap: 10px;
      align-items: center;
    }

    .hours-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #111;
    }

    .hours-row input[type="time"] {
      padding: 8px 10px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
    }

    .hours-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .btn-save-hours {
      padding: 10px 16px;
      background: #00a884;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-save-hours:hover {
      background: #008f6c;
    }

    .exceptions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .exceptions-table th,
    .exceptions-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .exceptions-table th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .exception-form {
      display: grid;
      grid-template-columns: 180px 1fr 140px;
      gap: 10px;
      align-items: center;
    }

    .exception-form input,
    .exception-form button,
    .exception-form textarea {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
    }

    .exception-form button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .exception-form button:hover {
      background: #5568d3;
    }

    .btn-delete-exception {
      padding: 6px 12px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .message-textarea {
      width: 100%;
      min-height: 90px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    /* Blacklist */
    .blacklist-container {
      display: none;
    }

    .blacklist-container.active {
      display: block;
    }

    .blacklist-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .blacklist-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .blacklist-form textarea,
    .blacklist-form input {
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .blacklist-form textarea {
      grid-column: 1 / -1;
      min-height: 80px;
      resize: vertical;
    }

    .blacklist-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #111;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .blacklist-table {
      width: 100%;
      border-collapse: collapse;
    }

    .blacklist-table th,
    .blacklist-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Toast de Alerta */
    .custom-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      max-width: 350px;
      border-left: 4px solid #00a884;
    }

    .custom-toast.error {
      border-left-color: #ff6b6b;
    }

    .custom-toast.warning {
      border-left-color: #ffa500;
    }

    .custom-toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .custom-toast-message {
      flex: 1;
      font-size: 14px;
      color: #111;
    }

    .custom-toast-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #667781;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .custom-toast.hiding {
      animation: slideOutRight 0.3s ease;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #111;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .btn-save {
      background: #667eea;
      color: white;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #111;
    }

    .btn-modal:hover {
      opacity: 0.8;
    }

    /* Responsividade Mobile (drawer + layout touch-friendly) */
    @media (max-width: 768px) {
      body {
        overflow: hidden;
      }

      .menu-btn {
        display: inline-flex;
      }

      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: min(86vw, 320px);
        border-right: none;
        transform: translateX(-105%);
        transition: transform 220ms cubic-bezier(.2,.9,.2,1);
        z-index: 1001;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 0;
        overflow-y: auto;
        border-bottom: none;
      }

      .nav-item {
        white-space: normal;
        padding: 12px 16px;
        border-right: 3px solid transparent;
        border-bottom: none;
        border-radius: 0;
      }

      .nav-item.active {
        border-right-color: #00a884;
        border-bottom-color: transparent;
      }

      .main-content {
        width: 100%;
      }

      .header {
        padding: 12px 14px;
        position: sticky;
        top: 0;
        z-index: 20;
      }

      .header h1 {
        font-size: 18px;
      }

      .content {
        padding: 14px;
      }

      .tickets-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        min-width: 0;
      }

      .filter-actions {
        margin-left: 0;
      }

      .sellers-grid {
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .seller-card {
        padding: 16px;
      }

      .seller-actions {
        flex-direction: column;
      }

      .btn-small {
        padding: 10px 12px;
        font-size: 13px;
      }

      .blacklist-form {
        grid-template-columns: 1fr;
      }

      .blacklist-actions {
        flex-direction: column;
      }

      .exception-form {
        grid-template-columns: 1fr;
      }

      .exception-form button {
        width: 100%;
      }

      .hours-row {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "day toggle"
          "open close";
        gap: 10px;
      }

      .hours-row .hours-day {
        grid-area: day;
        font-weight: 600;
        color: #111;
      }

      .hours-row label {
        grid-area: toggle;
        justify-content: flex-end;
      }

      .hours-row input[data-field="open_time"] {
        grid-area: open;
      }

      .hours-row input[data-field="close_time"] {
        grid-area: close;
      }

      .table-scroll table {
        min-width: 720px;
      }

      .modal-content {
        width: min(96vw, 520px);
        padding: 18px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .custom-toast {
        left: 12px;
        right: 12px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .sidebar-header {
        padding: 16px;
      }

      .header h1 {
        font-size: 16px;
      }

      .btn-new-seller {
        padding: 10px 12px;
        font-size: 13px;
      }

      .panel {
        padding: 16px;
      }
    }
  </style>
  <link rel="stylesheet" href="/ui.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Admin</h2>
        <p style="font-size: 12px; opacity: 0.9;" id="adminName">Admin</p>
      </div>

      <div class="sidebar-nav">
        <div class="nav-item active" data-section="sellers" onclick="showSection('sellers')">
          <span>üë®‚Äçüíº</span>
          Usu√°rios
        </div>

        
        <div class="nav-item" data-section="tickets" onclick="showSection('tickets')">
          <span>üìã</span>
          Tickets
        </div>
        <div class="nav-item" data-section="blacklist" onclick="showSection('blacklist')">
          <span>üö´</span>
          Blacklist
        </div>
        <div class="nav-item" data-section="hours" onclick="showSection('hours')">
          <span>üóìÔ∏è</span>
          Hor√°rios de Funcionamento
        </div>
        <div class="nav-item" data-section="await" onclick="showSection('await')">
          <span>‚è≥</span>
          Aguardando autom√°tico
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="back-btn" onclick="goBackToChats()">‚Üê Voltar aos Chats</button>
        <button class="whatsapp-logout-btn" onclick="disconnectWhatsApp()">Desconectar WhatsApp</button>
        <button class="logout-btn" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <div class="header-left">
          <button class="menu-btn" id="menuBtn" type="button" aria-label="Abrir menu" onclick="toggleSidebar()">‚ò∞</button>
          <h1 id="sectionTitle">Gerenciar Vendedores</h1>
        </div>
        <button id="headerBtn" class="btn-new-seller" onclick="openNewSellerModal()">+ Novo Usu√°rio</button>
      </div>

      <div class="content">
        <!-- Sellers Section -->
        <div class="sellers-container active" id="sellersSection">
          <div id="sellersList"></div>
        </div>

        <!-- Tickets Section -->
        <div class="tickets-container" id="ticketsSection">
          <div class="panel">
            <div class="tickets-toolbar">
              <div class="filter-group">
                <label for="ticketSellerFilter">Vendedor</label>
                <select id="ticketSellerFilter" class="filter-control" onchange="applyTicketFilters()"></select>
              </div>

              <div class="filter-group">
                <label for="ticketTimePreset">Per√≠odo</label>
                <select id="ticketTimePreset" class="filter-control" onchange="applyTicketTimePreset()">
                  <option value="">Qualquer data</option>
                  <option value="today">Hoje</option>
                  <option value="yesterday">Ontem</option>
                  <option value="last_24h">√öltimas 24 horas</option>
                  <option value="last_7d">√öltimos 7 dias</option>
                  <option value="last_30d">√öltimos 30 dias</option>
                  <option value="this_month">Este m√™s</option>
                  <option value="prev_month">M√™s passado</option>
                  <option value="custom">Personalizado</option>
                </select>
              </div>

              <div class="filter-group" style="min-width: 380px;">
                <label>Atualizado entre</label>
                <div class="filter-inline" style="flex-wrap: wrap; gap: 8px;">
                  <div style="flex: 1; min-width: 130px;">
                    <label style="font-size: 0.85em; color: #667781;">De (DD/MM/YYYY)</label>
                    <input id="ticketUpdatedFrom" class="filter-control" type="text" placeholder="DD/MM/YYYY" aria-label="Atualizado de (data)" inputmode="numeric" />
                  </div>
                  <div style="flex: 1; min-width: 100px;">
                    <label style="font-size: 0.85em; color: #667781;">Hora</label>
                    <input id="ticketUpdatedFromTime" class="filter-control" type="time" aria-label="Atualizado de (hora)" oninput="onTicketTimeRangeInputChanged()" />
                  </div>
                  <div style="flex: 1; min-width: 130px;">
                    <label style="font-size: 0.85em; color: #667781;">At√© (DD/MM/YYYY)</label>
                    <input id="ticketUpdatedTo" class="filter-control" type="text" placeholder="DD/MM/YYYY" aria-label="Atualizado at√© (data)" inputmode="numeric" />
                  </div>
                  <div style="flex: 1; min-width: 100px;">
                    <label style="font-size: 0.85em; color: #667781;">Hora</label>
                    <input id="ticketUpdatedToTime" class="filter-control" type="time" aria-label="Atualizado at√© (hora)" oninput="onTicketTimeRangeInputChanged()" />
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label for="ticketStatusFilter">A√ß√£o (status)</label>
                <select id="ticketStatusFilter" class="filter-control" onchange="applyTicketFilters()">
                  <option value="">Todos</option>
                  <option value="pendente">Pendente</option>
                  <option value="em_atendimento">Em atendimento</option>
                  <option value="aguardando">Aguardando</option>
                  <option value="resolvido">Resolvido</option>
                  <option value="encerrado">Encerrado</option>
                </select>
              </div>

              <div class="filter-actions">
                <button class="btn-secondary" type="button" onclick="clearTicketFilters()">Limpar filtros</button>
              </div>
            </div>

            <div class="table-scroll">
              <table class="tickets-table">
                <thead>
                  <tr>
                    <th>Contato</th>
                    <th>Telefone</th>
                    <th>Vendedor</th>
                    <th>Status</th>
                    <th>Atualizado em</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="ticketsTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Blacklist Section -->
        <div class="blacklist-container" id="blacklistSection">
          <div class="blacklist-grid">
            <div class="panel">
              <h3>Adicionar n√∫mero</h3>
              <form id="blacklistForm" class="blacklist-form" onsubmit="addBlacklist(event)">
                <input type="text" id="blacklistPhone" placeholder="Ex: 5511999999999" required>
                <input type="text" id="blacklistReason" placeholder="Motivo (opcional)">
                <textarea id="blacklistReasonDetails" placeholder="Detalhes adicionais (opcional)"></textarea>
                <div class="blacklist-actions">
                  <button class="btn-primary" type="submit">Adicionar</button>
                  <button class="btn-secondary" type="reset">Limpar</button>
                </div>
              </form>
            </div>

            <div class="panel">
              <h3>Lista de n√∫meros bloqueados</h3>
              <div class="table-scroll">
                <table class="blacklist-table">
                  <thead>
                    <tr>
                      <th>Telefone</th>
                      <th>Motivo</th>
                      <th>Adicionado em</th>
                      <th>A√ß√£o</th>
                    </tr>
                  </thead>
                  <tbody id="blacklistTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Hours Section -->
        <div class="hours-container" id="hoursSection">
          <div class="panel">
            <h3>Mensagem autom√°tica fora do hor√°rio</h3>
            <textarea id="outOfHoursMessage" class="message-textarea" placeholder="Digite a mensagem autom√°tica..."></textarea>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveOutOfHoursMessage()">Salvar mensagem</button>
            </div>
          </div>

          <div class="panel">
            <h3>Hor√°rios por dia</h3>
            <div class="hours-grid" id="hoursGrid"></div>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveBusinessHours()">Salvar hor√°rios</button>
            </div>
          </div>
          

          <div class="panel">
            <h3>Datas de exce√ß√£o (feriados)</h3>
            <div class="exception-form">
              <input type="text" id="exceptionDate" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatExceptionDateInput(event)">
              <input type="text" id="exceptionReason" placeholder="Motivo (ex: feriado)">
              <button onclick="addException()">Adicionar</button>
            </div>
            <div class="table-scroll">
              <table class="exceptions-table">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Motivo</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="exceptionsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Await Configuration Section -->
        <div class="await-container" id="awaitSection">
          <div class="panel">
            <h3>Configura√ß√£o: Aguardando autom√°tico</h3>
            <p style="color: #667781; font-size: 13px; margin-bottom: 8px;">Defina quantos minutos de inatividade em "Em Atendimento" fazem o ticket passar automaticamente para "Aguardando".</p>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="number" id="awaitMinutes" min="0" style="width: 120px; padding: 8px; border: 1px solid #d1d7db; border-radius: 6px;" />
              <div style="flex: 1; color: #667781; font-size: 13px;">Minutos (0 para desativar)</div>
            </div>
            <div class="hours-actions" style="margin-top: 12px;">
              <button class="btn-save-hours" onclick="saveAwaitConfig()">Salvar configura√ß√£o</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para criar/editar vendedor -->
  <div class="modal" id="sellerModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Novo Usu√°rio</div>
      
      <form id="sellerForm" onsubmit="saveSeller(event)">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="sellerName" required>
        </div>

        <div class="form-group">
          <label>Senha *</label>
          <input type="password" id="sellerPassword" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-modal btn-cancel" onclick="closeSellerModal()">Cancelar</button>
          <button type="submit" class="btn-modal btn-save">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header" id="confirmTitle">Confirmar a√ß√£o</div>
      <p id="confirmMessage" style="margin-bottom: 20px; color: #667781; font-size: 14px;"></p>
      <div class="modal-actions">
        <button type="button" class="btn-modal btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
        <button type="button" class="btn-modal btn-save" onclick="confirmModalAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // Use URLs relativas para evitar problemas de protocolo (http/https) e CORS.
    const API_URL = '';

    // Helper para formatar mensagens de erro com detalhes
    function formatErrorMessage(data) {
      if (!data) return 'Erro desconhecido';
      if (data.details && Array.isArray(data.details)) {
        // Remove o prefixo "campo: " de cada mensagem
        return data.details.map(msg => {
          const colonIndex = msg.indexOf(':');
          return colonIndex > 0 ? msg.substring(colonIndex + 1).trim() : msg;
        }).join('; ');
      }
      if (data.details && typeof data.details === 'string') {
        // Remove o prefixo "campo: " se existir
        const colonIndex = data.details.indexOf(':');
        return colonIndex > 0 ? data.details.substring(colonIndex + 1).trim() : data.details;
      }
      return data.error || 'Erro desconhecido';
    }

    let sellers = [];
    let tickets = [];
    let editingId = null;
    let businessHours = [];
    let exceptions = [];
    const DAYS = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    let blacklist = [];
    let confirmCallback = null;

    const UNASSIGNED_FILTER = '__unassigned__';
    let ticketFiltersDebounceTimer = null;

    function pad2(n) {
      return String(n).padStart(2, '0');
    }

    function toDateTimeLocalValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Usa hor√°rio local do browser (brasileiro)
      const year = date.getFullYear();
      const month = pad2(date.getMonth() + 1);
      const day = pad2(date.getDate());
      const hours = pad2(date.getHours());
      const minutes = pad2(date.getMinutes());
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function toDateValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Retorna DD/MM/YYYY para input text
      const day = pad2(date.getDate());
      const month = pad2(date.getMonth() + 1);
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function toTimeValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Retorna HH:mm para input type="time"
      const hours = pad2(date.getHours());
      const minutes = pad2(date.getMinutes());
      return `${hours}:${minutes}`;
    }

    function formatDateBR(input) {
      // Extrair apenas n√∫meros que est√£o no input
      let rawValue = input.value.replace(/\D/g, '');
      
      // Limitar a 8 d√≠gitos (DD+MM+YYYY)
      rawValue = rawValue.substring(0, 8);
      
      // Construir o valor formatado
      let formatted = '';
      
      if (rawValue.length > 0) {
        formatted = rawValue.substring(0, 2);
      }
      if (rawValue.length > 2) {
        formatted += '/' + rawValue.substring(2, 4);
      }
      if (rawValue.length > 4) {
        formatted += '/' + rawValue.substring(4, 8);
      }
      
      // Atualizar o valor do input
      input.value = formatted;
    }
    
    function setupDateInputMask(inputSelector) {
      const input = document.querySelector(inputSelector);
      if (!input) return;
      
      // Bloquear caracteres n√£o-num√©ricos em tempo real
      input.addEventListener('keypress', function(e) {
        const char = String.fromCharCode(e.which);
        if (!/[0-9]/.test(char)) {
          e.preventDefault();
          return false;
        }
      });
      
      // Formatar ao digitar
      input.addEventListener('input', function(e) {
        formatDateBR(this);
        // Disparar evento de mudan√ßa personalizado para os filtros
        if (onTicketTimeRangeInputChanged) {
          setTimeout(() => onTicketTimeRangeInputChanged(), 10);
        }
      });
      
      // Permitir paste
      input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        // Extrair apenas n√∫meros do paste
        const numbersOnly = pastedText.replace(/\D/g, '');
        this.value = numbersOnly;
        formatDateBR(this);
        if (onTicketTimeRangeInputChanged) {
          setTimeout(() => onTicketTimeRangeInputChanged(), 10);
        }
      });
    }

    function dateStringBRToISO(dateStr) {
      // Converte DD/MM/YYYY para YYYY-MM-DD
      if (!dateStr || dateStr.length !== 10) return null;
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      const dd = parts[0];
      const mm = parts[1];
      const yyyy = parts[2];
      if (!/^\d{2}$/.test(dd) || !/^\d{2}$/.test(mm) || !/^\d{4}$/.test(yyyy)) return null;
      return `${yyyy}-${mm}-${dd}`;
    }

    function startOfDay(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfDay(date) {
      const d = new Date(date);
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function startOfMonth(date) {
      const d = new Date(date);
      d.setDate(1);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfMonth(date) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + 1, 0);
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function isMobileLayout() {
      return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
    }

    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) sidebar.classList.add('open');
      if (overlay) overlay.classList.add('active');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) sidebar.classList.remove('open');
      if (overlay) overlay.classList.remove('active');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      if (sidebar.classList.contains('open')) closeSidebar();
      else openSidebar();
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    window.addEventListener('resize', () => {
      if (!isMobileLayout()) closeSidebar();
    });

    // Verificar autentica√ß√£o via sess√£o
    async function checkAuth() {
      try {
        const response = await fetch(`${API_URL}/auth/session`, {
          credentials: 'include'
        });

        if (!response.ok) {
          if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
          return;
        }

        const data = await response.json();
        
        if (data.userType !== 'admin') {
          if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
          return;
        }

        document.getElementById('adminName').textContent = data.userName;
      } catch (error) {
        if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
      }
    }

    async function disconnectWhatsApp() {
      openConfirmModal('Desconectar WhatsApp? Isso vai limpar os dados do atendimento.', async () => {
        try {
          await fetch(`${API_URL}/whatsapp/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          // Ignora
        }

        try {
          await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          // Ignora
        }

        if (typeof navigateTo === 'function') navigateTo('/whatsapp-qr'); else window.location.href = '/whatsapp-qr';
      });
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        // Ignora erros de logout
      }
      if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
    }

    function showSection(section) {
      // update nav active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === section);
      });

      // close drawer on mobile after selecting a section
      if (isMobileLayout()) closeSidebar();

      // graceful transition: fade out current active section, then switch
      const current = document.querySelector('[id$="Section"].active');
      const finishSwitch = () => {
        document.querySelectorAll('[id$="Section"]').forEach(div => div.classList.remove('active'));

        if (section === 'sellers') {
          document.getElementById('sellersSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Gerenciar Usu√°rios';
          document.getElementById('headerBtn').style.display = 'block';
          document.getElementById('headerBtn').textContent = '+ Novo Usu√°rio';
          document.getElementById('headerBtn').onclick = openNewSellerModal;
          loadUsers();
        } else if (section === 'tickets') {
          document.getElementById('ticketsSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Tickets';
          document.getElementById('headerBtn').style.display = 'none';
          loadTickets();
        } else if (section === 'blacklist') {
          document.getElementById('blacklistSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Blacklist';
          document.getElementById('headerBtn').style.display = 'none';
          loadBlacklist();
        } else if (section === 'hours') {
          document.getElementById('hoursSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Hor√°rios de Funcionamento';
          document.getElementById('headerBtn').style.display = 'none';
          loadBusinessHours();
          loadExceptions();
          loadOutOfHoursMessage();
        } else if (section === 'await') {
          document.getElementById('awaitSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Aguardando autom√°tico';
          document.getElementById('headerBtn').style.display = 'none';
          loadAwaitConfig();
        }

        // reveal new active
        const newActive = document.querySelector('[id$="Section"].active');
        if (newActive) {
          newActive.classList.remove('hidden');
        }
      };

      if (current) {
        // smoothly hide
        current.classList.add('fade', 'hidden');
        setTimeout(finishSwitch, 220);
      } else {
        finishSwitch();
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/users`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          let msg = 'Erro ao carregar usu√°rios';
          if (response.status === 401) msg = 'Sess√£o expirada. Fa√ßa login novamente.';
          else if (response.status === 403) msg = 'Acesso negado. Apenas administradores.';
          else {
            try {
              const err = await response.json();
              if (err && err.error) msg = err.error;
            } catch (_) {}
          }
          console.error('Erro ao carregar usu√°rios:', response.status, msg);
          if (typeof showNotification === 'function') showNotification(msg, 'error'); else showToast(msg, 'error');
          return;
        }
        
        sellers = await response.json();
        renderUsers();
        renderTicketSellerFilterOptions();
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        if (typeof showNotification === 'function') showNotification('N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.', 'error'); else showToast('N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.', 'error');
      }
    }

    function parseDateSafe(value) {
      if (value == null || value === '') return null;
      const str = String(value).trim();
      if (!str) return null;
      // Tenta parsing direto
      let d = new Date(str);
      if (!isNaN(d.getTime())) return d;
      // Tenta com normaliza√ß√£o (espa√ßo ‚Üí T)
      const normalized = str.replace(/\s+/g, 'T').replace(/\.\d{3}Z?$/i, '');
      d = new Date(normalized);
      if (!isNaN(d.getTime())) return d;
      return null;
    }

    function getNumericIdFromComposite(id) {
      if (id == null || id === '') return null;
      const str = String(id);
      if (str.includes('_')) {
        const parts = str.split('_');
        return parts[1] || null;
      }
      return str;
    }

    function renderTicketSellerFilterOptions() {
      const select = document.getElementById('ticketSellerFilter');
      if (!select) return;

      const prev = select.value;
      const sellersSorted = Array.isArray(sellers)
        ? [...sellers].filter(s => s?.isSeller).sort((a, b) => (a.name || '').localeCompare(b.name || ''))
        : [];

      select.innerHTML = [
        `<option value="">Todos</option>`,
        `<option value="${UNASSIGNED_FILTER}">N√£o atribu√≠do</option>`,
        ...sellersSorted.map(s => {
          // Extrai ID num√©rico do formato 'seller_X' ou 'admin_X'
          const numericId = getNumericIdFromComposite(s.id);
          return `<option value="${numericId}" data-composite-id="${s.id}">${s.name || s.id}</option>`;
        }),
      ].join('');

      if (prev && [...select.options].some(o => o.value === prev)) {
        select.value = prev;
      }
    }

    function applyTicketFiltersDebounced() {
      if (ticketFiltersDebounceTimer) clearTimeout(ticketFiltersDebounceTimer);
      ticketFiltersDebounceTimer = setTimeout(() => {
        ticketFiltersDebounceTimer = null;
        applyTicketFilters();
      }, 180);
    }

    function onTicketTimeRangeInputChanged() {
      const presetEl = document.getElementById('ticketTimePreset');
      const fromDateStr = document.getElementById('ticketUpdatedFrom')?.value || '';
      const fromTimeStr = document.getElementById('ticketUpdatedFromTime')?.value || '';
      const toDateStr = document.getElementById('ticketUpdatedTo')?.value || '';
      const toTimeStr = document.getElementById('ticketUpdatedToTime')?.value || '';
      if (presetEl) {
        if ((fromDateStr || toDateStr || fromTimeStr || toTimeStr) && presetEl.value !== 'custom') {
          presetEl.value = 'custom';
        }
        if (!fromDateStr && !toDateStr && !fromTimeStr && !toTimeStr && presetEl.value === 'custom') {
          presetEl.value = '';
        }
      }
      applyTicketFiltersDebounced();
    }

    function applyTicketTimePreset() {
      const preset = document.getElementById('ticketTimePreset')?.value || '';
      const fromDateEl = document.getElementById('ticketUpdatedFrom');
      const fromTimeEl = document.getElementById('ticketUpdatedFromTime');
      const toDateEl = document.getElementById('ticketUpdatedTo');
      const toTimeEl = document.getElementById('ticketUpdatedToTime');
      // Usa hor√°rio local do browser (brasileiro)
      const now = new Date();

      if (!fromDateEl || !toDateEl || !fromTimeEl || !toTimeEl) {
        applyTicketFilters();
        return;
      }

      if (!preset) {
        fromDateEl.value = '';
        toDateEl.value = '';
        fromTimeEl.value = '';
        toTimeEl.value = '';
        applyTicketFilters();
        return;
      }

      if (preset === 'custom') {
        applyTicketFilters();
        return;
      }

      let from = null;
      let to = null;

      if (preset === 'today') {
        from = startOfDay(now);
        to = now;
      } else if (preset === 'yesterday') {
        const y = new Date(now);
        y.setDate(y.getDate() - 1);
        from = startOfDay(y);
        to = endOfDay(y);
      } else if (preset === 'last_24h') {
        from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'last_7d') {
        from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'last_30d') {
        from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'this_month') {
        from = startOfMonth(now);
        to = now;
      } else if (preset === 'prev_month') {
        const prev = new Date(now);
        prev.setMonth(prev.getMonth() - 1);
        from = startOfMonth(prev);
        to = endOfMonth(prev);
      }

      if (from && to) {
        fromDateEl.value = toDateValue(from);
        fromTimeEl.value = toTimeValue(from);
        toDateEl.value = toDateValue(to);
        toTimeEl.value = toTimeValue(to);
      }

      applyTicketFilters();
    }

    function applyTicketFilters() {
      const sellerFilter = document.getElementById('ticketSellerFilter')?.value || '';
      const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';
      const fromDateStr = document.getElementById('ticketUpdatedFrom')?.value || '';
      const fromTimeStr = document.getElementById('ticketUpdatedFromTime')?.value || '';
      const toDateStr = document.getElementById('ticketUpdatedTo')?.value || '';
      const toTimeStr = document.getElementById('ticketUpdatedToTime')?.value || '';

      // Converte DD/MM/YYYY para YYYY-MM-DD e combina com hora
      let fromMs = null;
      let toMs = null;

      if (fromDateStr) {
        const fromIso = dateStringBRToISO(fromDateStr);
        if (fromIso) {
          const fromDateTime = fromTimeStr ? `${fromIso}T${fromTimeStr}` : `${fromIso}T00:00`;
          const fromDate = new Date(fromDateTime);
          if (!Number.isNaN(fromDate.getTime())) fromMs = fromDate.getTime();
        }
      }

      if (toDateStr) {
        const toIso = dateStringBRToISO(toDateStr);
        if (toIso) {
          const toDateTime = toTimeStr ? `${toIso}T${toTimeStr}` : `${toIso}T23:59`;
          const toDate = new Date(toDateTime);
          if (!Number.isNaN(toDate.getTime())) toMs = toDate.getTime();
        }
      }

      if (fromMs != null && toMs != null && fromMs > toMs) {
        const tmp = fromMs;
        fromMs = toMs;
        toMs = tmp;
      }

      const filtered = (Array.isArray(tickets) ? tickets : []).filter(t => {
        if (sellerFilter) {
          if (sellerFilter === UNASSIGNED_FILTER) {
            // N√£o atribu√≠do: seller_id deve ser null/undefined/0/''
            if (t.seller_id != null && t.seller_id !== 0 && t.seller_id !== '') return false;
          } else {
            // Comparar como n√∫mero (backend retorna number na tabela sellers)
            const ticketSellerId = t.seller_id == null ? null : Number(t.seller_id);
            const filterSellerId = Number(sellerFilter);
            if (Number.isNaN(filterSellerId) || ticketSellerId !== filterSellerId) return false;
          }
        }

        if (statusFilter) {
          const ticketStatus = String(t.status || '').trim().toLowerCase().replace(/\s+/g, '_');
          const filterStatus = String(statusFilter).trim().toLowerCase().replace(/\s+/g, '_');
          if (ticketStatus !== filterStatus) return false;
        }

        if (fromMs != null || toMs != null) {
          const d = parseDateSafe(t.updated_at);
          if (!d) return false;
          const ts = d.getTime();
          if (fromMs != null && ts < fromMs) return false;
          if (toMs != null && ts > toMs) return false;
        }

        return true;
      }).sort((a, b) => {
        const da = parseDateSafe(a.updated_at)?.getTime() || 0;
        const dbb = parseDateSafe(b.updated_at)?.getTime() || 0;
        return dbb - da;
      });

      const hasActiveFilters = !!(sellerFilter || statusFilter || fromMs != null || toMs != null);
      renderTickets(filtered, { filtered: hasActiveFilters });
    }

    function clearTicketFilters() {
      const sellerEl = document.getElementById('ticketSellerFilter');
      const statusEl = document.getElementById('ticketStatusFilter');
      const presetEl = document.getElementById('ticketTimePreset');
      const fromDateEl = document.getElementById('ticketUpdatedFrom');
      const fromTimeEl = document.getElementById('ticketUpdatedFromTime');
      const toDateEl = document.getElementById('ticketUpdatedTo');
      const toTimeEl = document.getElementById('ticketUpdatedToTime');
      if (sellerEl) sellerEl.value = '';
      if (statusEl) statusEl.value = '';
      if (presetEl) presetEl.value = '';
      if (fromDateEl) fromDateEl.value = '';
      if (fromTimeEl) fromTimeEl.value = '';
      if (toDateEl) toDateEl.value = '';
      if (toTimeEl) toTimeEl.value = '';
      applyTicketFilters();
    }

    function formatCreatedAt(value) {
      if (value == null || value === '') return '‚Äî';
      const str = String(value).trim();
      if (!str) return '‚Äî';
      const normalized = str.replace(' ', 'T').replace(/\.\d{3}Z?$/i, '');
      let d = new Date(normalized);
      if (isNaN(d.getTime())) d = new Date(str);
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function renderUsers() {
      const container = document.getElementById('sellersList');
      
      if (sellers.length === 0) {
        container.innerHTML = '<p style="color: #667781; text-align: center;">Nenhum usu√°rio cadastrado</p>';
        return;
      }

      container.innerHTML = sellers.map(user => {
        const type = [];
        if (user.isAdmin) type.push('üëë Admin');
        if (user.isSeller) type.push('üë®‚Äçüíº Vendedor');
        const typeText = type.length > 0 ? type.join(' ‚Ä¢ ') : 'Sem papel';
        
        return `
        <div class="seller-card">
          <div class="seller-header">
            <div class="seller-name">${user.name}</div>
            <div class="seller-status ${(user.isAdmin || (user.isSeller && user.sellerActive)) ? 'status-active' : 'status-inactive'}">
              ${typeText}
            </div>
          </div>
          <div class="seller-info">
            Criado em: ${formatCreatedAt(user.created_at)}
          </div>
          <div class="seller-actions">
            ${!user.isAdmin && user.isSeller ? `<button class="btn-small btn-edit" onclick="makeAdminSeller('${user.id}', '${(user.name || '').replace(/'/g, "\\'")}')">üëë Fazer Admin</button>` : ''}
            ${!user.isAdmin && !user.isSeller ? `<button class="btn-small btn-edit" onclick="makeAdminUser('${(user.name || '').replace(/'/g, "\\'")}')">üëë Fazer Admin</button>` : ''}
            ${user.isAdmin && !user.isSeller ? `<button class="btn-small btn-edit" onclick="revertToSeller('${(user.name || '').replace(/'/g, "\\'")}')">üë®‚Äçüíº Tornar apenas vendedor</button>` : ''}
            ${user.isAdmin && user.isSeller ? `<button class="btn-small btn-edit" onclick="revertToSeller('${(user.name || '').replace(/'/g, "\\'")}')">üë®‚Äçüíº Tornar apenas vendedor</button>` : ''}
            ${user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerAdmin('${(user.name || '').replace(/'/g, "\\'")}')">‚ùå Remover Vendedor</button>` : ''}
            ${!user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerOnly('${user.id || ''}', '${(user.name || '').replace(/'/g, "\\'")}')">‚ùå Remover</button>` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    async function loadTickets() {
      try {
        if (!Array.isArray(sellers) || sellers.length === 0) {
          await loadUsers();
        }
        const response = await fetch(`${API_URL}/admin/tickets`, {
          credentials: 'include'
        });
        tickets = await response.json();
        renderTicketSellerFilterOptions();
        applyTicketFilters();
      } catch (error) {
        // Erro ao carregar tickets
      }
    }

    function renderTickets(list = tickets, { filtered = false } = {}) {
      const tbody = document.getElementById('ticketsTableBody');
      
      const items = Array.isArray(list) ? list : [];
      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #667781;">${filtered ? 'Nenhum ticket para este filtro' : 'Nenhum ticket'}</td></tr>`;
        return;
      }

      tbody.innerHTML = items.map(ticket => `
        <tr>
          <td>${ticket.contact_name || '-'}</td>
          <td class="ticket-phone">${ticket.phone}</td>
          <td class="ticket-seller">${ticket.seller_name || 'N√£o atribu√≠do'}</td>
          <td><span class="ticket-status status-${ticket.status}">${ticket.status.replace('_', ' ')}</span></td>
          <td>${new Date(ticket.updated_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
          <td>
            <select class="assign-select" onchange="assignTicket(${ticket.id}, this.value)">
              <option value="">Atribuir...</option>
              <option value="0" ${!ticket.seller_id ? 'selected' : ''}>N√£o atribu√≠do</option>
              ${sellers
                .filter(s => s?.isSeller)
                .map(s => {
                  const numericId = getNumericIdFromComposite(s.id);
                  const selected = (ticket.seller_id != null && numericId != null)
                    ? Number(ticket.seller_id) === Number(numericId)
                    : false;
                  return `<option value="${numericId}" ${selected ? 'selected' : ''}>${s.name}</option>`;
                })
                .join('')}
            </select>
          </td>
        </tr>
      `).join('');
    }

    async function loadBusinessHours() {
      try {
        const response = await fetch(`${API_URL}/business-hours`, {
          credentials: 'include'
        });
        businessHours = await response.json();
        renderBusinessHours();
      } catch (error) {
        // Erro ao carregar hor√°rios
      }
    }

    function renderBusinessHours() {
      const grid = document.getElementById('hoursGrid');
      const ordered = [...businessHours].sort((a, b) => a.day - b.day);

      if (!ordered.length) {
        grid.innerHTML = '<p style="color: #667781;">Nenhum hor√°rio configurado.</p>';
        return;
      }

      grid.innerHTML = ordered.map(item => `
        <div class="hours-row">
          <div class="hours-day">${DAYS[item.day]}</div>
          <label>
            <input type="checkbox" class="hours-enabled" data-day="${item.day}" ${item.enabled ? 'checked' : ''}>
            Aberto
          </label>
          <input type="time" data-day="${item.day}" data-field="open_time" value="${item.open_time || ''}">
          <input type="time" data-day="${item.day}" data-field="close_time" value="${item.close_time || ''}">
        </div>
      `).join('');

      document.querySelectorAll('.hours-enabled').forEach(cb => {
        const day = cb.dataset.day;
        const inputs = document.querySelectorAll(`input[data-day="${day}"][data-field]`);
        inputs.forEach(input => {
          input.disabled = !cb.checked;
        });
        cb.addEventListener('change', () => {
          inputs.forEach(input => {
            input.disabled = !cb.checked;
          });
        });
      });
    }

    async function saveBusinessHours() {
      try {
        const hours = DAYS.map((_, day) => {
          const enabled = document.querySelector(`.hours-enabled[data-day="${day}"]`)?.checked;
          const open = document.querySelector(`input[data-day="${day}"][data-field="open_time"]`)?.value;
          const close = document.querySelector(`input[data-day="${day}"][data-field="close_time"]`)?.value;
          return {
            day,
            enabled: !!enabled,
            open_time: open || null,
            close_time: close || null
          };
        });

        const response = await fetch(`${API_URL}/business-hours`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ hours })
        });

        if (!response.ok) throw new Error('Erro ao salvar hor√°rios');
        if (typeof showNotification === 'function') showNotification('Hor√°rios atualizados', 'info'); else showToast('Hor√°rios atualizados', 'success');
        loadBusinessHours();
      } catch (error) {
        if (typeof showNotification === 'function') showNotification(error.message, 'error'); else showToast(error.message, 'error');
      }
    }

    async function loadExceptions() {
      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          credentials: 'include'
        });
        exceptions = await response.json();
        renderExceptions();
      } catch (error) {
        // Erro ao carregar exce√ß√µes
      }
    }

    async function loadBlacklist() {
      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          credentials: 'include'
        });
        blacklist = await response.json();
        renderBlacklist();
      } catch (error) {
        showToast('Erro ao carregar blacklist', 'error');
      }
    }

    function renderBlacklist() {
      const tbody = document.getElementById('blacklistTableBody');
      if (!Array.isArray(blacklist) || blacklist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #667781;">Nenhum n√∫mero bloqueado</td></tr>';
        return;
      }

      tbody.innerHTML = blacklist.map(item => `
        <tr>
          <td>${item.phone}</td>
          <td>${item.reason || '‚Äî'}</td>
          <td>${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
          <td><button class="btn-danger" onclick="removeBlacklist('${item.phone}')">Remover</button></td>
        </tr>
      `).join('');
    }

    async function addBlacklist(event) {
      event.preventDefault();

      let phone = document.getElementById('blacklistPhone').value.trim();
      const reason = document.getElementById('blacklistReason').value.trim();
      const details = document.getElementById('blacklistReasonDetails').value.trim();
      const fullReason = [reason, details].filter(Boolean).join(' - ');

      if (!phone.includes('@')) {
        phone = phone.replace(/\D/g, '') + '@s.whatsapp.net';
      }

      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ phone, reason: fullReason })
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(formatErrorMessage(data) || 'Erro ao adicionar');
        }

        showToast('N√∫mero adicionado com sucesso', 'success');
        document.getElementById('blacklistForm').reset();
        loadBlacklist();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function removeBlacklist(phone) {
      openConfirmModal(`Remover ${phone} da blacklist?`, async () => {
        try {
          const response = await fetch(`${API_URL}/blacklist/${encodeURIComponent(phone)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(formatErrorMessage(data) || 'Erro ao remover');
          }

          showToast('N√∫mero removido com sucesso', 'success');
          loadBlacklist();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    function formatISODateBR(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(`${dateStr}T00:00:00`);
      return date.toLocaleDateString('pt-BR');
    }

    // Formata o input enquanto o usu√°rio digita: dd/mm/aaaa
    function formatExceptionDateInput(event) {
      const el = event.target;
      let v = el.value.replace(/[^0-9]/g, '');
      if (v.length > 8) v = v.slice(0,8);
      if (v.length >= 5) el.value = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
      else if (v.length >= 3) el.value = v.slice(0,2) + '/' + v.slice(2);
      else el.value = v;
    }

    // Converte dd/mm/aaaa para ISO (aaaa-mm-dd). Retorna null se inv√°lido.
    function parseDateBR(value) {
      if (!value) return null;
      const trimmed = value.trim();
      // aceita dd/mm/aaaa
      const m = trimmed.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10);
        const year = parseInt(m[3], 10);
        if (month < 1 || month > 12) return null;
        const maxDay = new Date(year, month, 0).getDate();
        if (day < 1 || day > maxDay) return null;
        // return ISO
        const mm = String(month).padStart(2, '0');
        const dd = String(day).padStart(2, '0');
        return `${year}-${mm}-${dd}`;
      }

      // aceita ISO aaaa-mm-dd
      const iso = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (iso) {
        return trimmed;
      }

      return null;
    }

    function renderExceptions() {
      const tbody = document.getElementById('exceptionsTableBody');
      if (!exceptions.length) {
        tbody.innerHTML = '<tr><td colspan="3" style="color: #667781; text-align: center;">Nenhuma exce√ß√£o cadastrada</td></tr>';
        return;
      }

      tbody.innerHTML = exceptions.map(ex => `
        <tr>
          <td>${formatISODateBR(ex.date)}</td>
          <td>${ex.reason || '-'}</td>
          <td><button class="btn-delete-exception" onclick="deleteException(${ex.id})">Remover</button></td>
        </tr>
      `).join('');
    }

    async function addException() {
      const dateInput = document.getElementById('exceptionDate').value.trim();
      const reason = document.getElementById('exceptionReason').value;

      if (!dateInput) {
        showToast('Informe uma data', 'warning');
        return;
      }

      const isoDate = parseDateBR(dateInput);
      if (!isoDate) {
        showToast('Data inv√°lida. Use dd/mm/aaaa', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ date: isoDate, closed: true, reason })
        });

        if (!response.ok) throw new Error('Erro ao salvar exce√ß√£o');

        document.getElementById('exceptionDate').value = '';
        document.getElementById('exceptionReason').value = '';
        loadExceptions();
        showToast('Exce√ß√£o adicionada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteException(id) {
      openConfirmModal('Remover esta exce√ß√£o?', async () => {
        try {
          const response = await fetch(`${API_URL}/business-exceptions/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover exce√ß√£o');
          loadExceptions();
          showToast('Exce√ß√£o removida', 'success');
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function loadOutOfHoursMessage() {
      try {
        const response = await fetch(`${API_URL}/business-message`, {
          credentials: 'include'
        });
        const data = await response.json();
        document.getElementById('outOfHoursMessage').value = data.message || '';
      } catch (error) {
        // Erro ao carregar mensagem
      }
    }

    async function saveOutOfHoursMessage() {
      const message = document.getElementById('outOfHoursMessage').value.trim();
      if (!message) {
        showToast('Digite uma mensagem', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-message`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ message })
        });

        if (!response.ok) throw new Error('Erro ao salvar mensagem');
        showToast('Mensagem atualizada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Configura√ß√£o: Aguardando autom√°tico (mover de 'Em Atendimento' -> 'Aguardando')
    async function loadAwaitConfig() {
      try {
        const response = await fetch(`${API_URL}/admin/await-config`, {
          credentials: 'include'
        });
        if (!response.ok) return;
        const data = await response.json();
        const minutes = (data && typeof data.minutes === 'number') ? data.minutes : 0;
        document.getElementById('awaitMinutes').value = minutes;
      } catch (error) {
        // falha silenciosa
      }
    }

    async function saveAwaitConfig() {
      const raw = document.getElementById('awaitMinutes').value;
      const minutes = parseInt(raw, 10);
      if (Number.isNaN(minutes) || minutes < 0) {
        showToast('Informe um n√∫mero v√°lido de minutos (0 ou mais)', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/await-config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ minutes })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || 'Erro ao salvar configura√ß√£o');
        }

        showToast('Configura√ß√£o salva', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function openNewSellerModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
      document.getElementById('sellerName').value = '';
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = true;
      document.getElementById('sellerModal').classList.add('active');
    }

    function editSeller(id, name) {
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Editar Vendedor';
      document.getElementById('sellerName').value = name;
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = false;
      document.getElementById('sellerPassword').placeholder = 'Deixar em branco para manter a senha atual';
      document.getElementById('sellerModal').classList.add('active');
    }

    function closeSellerModal() {
      document.getElementById('sellerModal').classList.remove('active');
    }

    function openConfirmModal(message, onConfirm) {
      const modal = document.getElementById('confirmModal');
      const title = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const buttons = modal.querySelectorAll('.modal-actions .btn-modal');
      const cancelBtn = buttons[0];
      const confirmBtn = buttons[1];

      title.textContent = 'Confirmar a√ß√£o';
      messageEl.textContent = message;
      confirmCallback = onConfirm;
      cancelBtn.style.display = '';
      cancelBtn.textContent = 'Cancelar';
      confirmBtn.textContent = 'Confirmar';
      modal.classList.add('active');
    }

    function openAlertModal(message, titleText = 'Aten√ß√£o') {
      const modal = document.getElementById('confirmModal');
      const title = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const buttons = modal.querySelectorAll('.modal-actions .btn-modal');
      const cancelBtn = buttons[0];
      const confirmBtn = buttons[1];

      title.textContent = titleText;
      messageEl.textContent = message;
      confirmCallback = null;
      cancelBtn.style.display = 'none';
      confirmBtn.textContent = 'Entendi';
      modal.classList.add('active');
    }

    function closeConfirmModal() {
      confirmCallback = null;
      document.getElementById('confirmModal').classList.remove('active');
    }

    function confirmModalAction() {
      if (typeof confirmCallback === 'function') {
        confirmCallback();
      }
      closeConfirmModal();
    }

    async function saveSeller(event) {
      event.preventDefault();
      
      const name = document.getElementById('sellerName').value;
      const password = document.getElementById('sellerPassword').value;

      try {
        if (editingId) {
          const data = { name };
          if (password) data.password = password;
          
          const response = await fetch(`${API_URL}/sellers/${editingId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(formatErrorMessage(error) || 'Erro ao atualizar');
          }
          showToast('Vendedor atualizado com sucesso', 'success');
        } else {
          if (!password) {
            showToast('Senha √© obrigat√≥ria para Novo Usu√°rio', 'warning');
            return;
          }

          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(formatErrorMessage(error) || 'Erro ao criar');
          }
          showToast('Vendedor criado com sucesso', 'success');
        }

        closeSellerModal();
        loadUsers();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteSeller(id, name) {
      openConfirmModal(`Tem certeza que deseja deletar este vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao deletar');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminSeller(id, name) {
      const numId = (typeof id === 'string' && id.startsWith('seller_')) ? id.replace('seller_', '') : id;
      openConfirmModal(`Tornar ${name} admin? Ele deixar√° de ser vendedor e poder√° acessar a tela de administra√ß√£o.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${numId}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || 'Erro ao tornar admin');
          }
          showToast('Vendedor promovido a admin com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeAdminSeller(id, name) {
      openConfirmModal(`Remover status de admin de ${name}? Ele continuar√° como vendedor.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}/remove-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            if (response.status === 409) {
              openAlertModal(formatErrorMessage(data) || 'N√£o √© permitido remover o √∫ltimo admin do sistema.');
              return;
            }
            throw new Error(formatErrorMessage(data) || 'Erro ao remover admin');
          }
          showToast('Admin removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminUser(name) {
      openConfirmModal(`Tornar ${name} admin? Ele ter√° acesso total ao sistema.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password: Math.random().toString(36).slice(2) })
          });

          if (!response.ok) throw new Error('Erro ao criar vendedor');
          
          const seller = await response.json();
          
          const response2 = await fetch(`${API_URL}/sellers/${seller.id}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response2.ok) throw new Error('Erro ao tornar admin');
          showToast('Admin criado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeSellerAdmin(name) {
      openConfirmModal(`Fazer ${name} tamb√©m ser vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${name}/make-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao tornar vendedor');
          showToast('Vendedor adicionado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerAdmin(name) {
      openConfirmModal(`Remover ${name} de vendedor? Ele continuar√° como admin.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${encodeURIComponent(name)}/remove-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover vendedor');
          showToast('Vendedor removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function revertToSeller(name) {
      const displayName = (name || '').trim();
      openConfirmModal(`Tornar ${displayName} apenas vendedor? Ele deixar√° de ser admin e s√≥ poder√° acessar a tela de vendedor.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${encodeURIComponent(String(name))}/revert-to-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            if (response.status === 409) {
              openAlertModal(formatErrorMessage(data) || 'N√£o √© permitido remover o √∫ltimo admin do sistema.');
              return;
            }
            throw new Error(formatErrorMessage(data) || 'Erro ao reverter para vendedor');
          }
          showToast(data.message || 'Usu√°rio agora √© apenas vendedor', 'success');
          if (data.sessionDestroyed) {
            if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
            return;
          }
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerOnly(id, name) {
      const numId = (typeof id === 'string' && id.startsWith('seller_')) ? id.replace('seller_', '') : id;
      if (!numId) {
        showToast('ID do vendedor inv√°lido', 'error');
        return;
      }
      openConfirmModal(`Deletar vendedor ${name}? Esta a√ß√£o n√£o pode ser desfeita.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${numId}/remove-seller-only`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) throw new Error(formatErrorMessage(data) || 'Erro ao deletar vendedor');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function assignTicket(ticketId, sellerId) {
      try {
        const normalizedSellerId = (sellerId && String(sellerId) !== '0') ? Number(sellerId) : null;
        const response = await fetch(`${API_URL}/tickets/${ticketId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sellerId: Number.isFinite(normalizedSellerId) ? normalizedSellerId : null })
        });

        if (!response.ok) throw new Error('Erro ao atribuir');
        showToast('Ticket atribu√≠do com sucesso', 'success');
        loadTickets();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function goBackToChats() {
      if (typeof navigateTo === 'function') navigateTo('/agent'); else window.location.href = '/agent';
    }

    // Sistema de Toast customizado
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `custom-toast ${type}`;

      const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
      toast.innerHTML = `
        <div class="custom-toast-icon">${icon}</div>
        <div class="custom-toast-message">${message}</div>
        <button class="custom-toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Inicializar
    checkAuth();
    showSection('sellers');
    
    // Inicializar input mask de data para tickets
    setTimeout(function() {
      setupDateInputMask('#ticketUpdatedFrom');
      setupDateInputMask('#ticketUpdatedTo');
    }, 100);
  </script>
  <script src="/ui.js"></script>
</body>
</html>
