<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="color-scheme" content="light">
  <meta name="application-name" content="WhatsApp System">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WhatsApp System">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="apple-touch-icon" href="/icon-180.png">
  <!-- N√£o for√ßar downgrade para HTTP: permite operar em HTTPS quando configurado. -->
  <title>Admin - WhatsApp System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar-overlay {
      display: none;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      background: #00a884;
      color: white;
    }

    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .nav-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: center;
      color: #667781;
      font-size: 14px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: #f5f5f5;
    }

    .nav-item.active {
      background: #e9f7f3;
      color: #00a884;
      border-right: 3px solid #00a884;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .back-btn {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #5568d3;
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #ff5252;
    }

    .whatsapp-logout-btn {
      width: 100%;
      padding: 10px;
      background: #ffb020;
      color: #111;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .whatsapp-logout-btn:hover {
      background: #f59e0b;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .header {
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      background: #fff;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #111;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-btn:active {
      transform: scale(0.98);
    }

    .header h1 {
      font-size: 24px;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      -webkit-overflow-scrolling: touch;
    }

    .hidden {
      opacity: 0 !important;
      transform: translateY(8px) !important;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }

    /* Section panels: animate visibility smoothly */
    .sellers-container,
    .tickets-container,
    .blacklist-container,
    .hours-container,
    .await-container,
    .ranking-container {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform: translateY(8px);
      transition: opacity 280ms cubic-bezier(.2,.9,.2,1), transform 280ms cubic-bezier(.2,.9,.2,1), max-height 420ms ease;
      visibility: hidden;
    }

    .sellers-container.active,
    .tickets-container.active,
    .blacklist-container.active,
    .hours-container.active,
    .await-container.active,
    .ranking-container.active {
      opacity: 1;
      max-height: 2000px; /* large enough to show content */
      transform: none;
      visibility: visible;
    }

    .btn-new-seller {
      background: #00a884;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-new-seller:hover {
      background: #008f6c;
    }

    .sellers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .seller-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s;
    }

    .seller-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .seller-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .seller-name {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .seller-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .seller-info {
      color: #667781;
      font-size: 13px;
      margin-bottom: 15px;
    }

    .seller-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .btn-edit {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #ff6b6b;
      color: white;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    /* Tickets View */
    .tickets-container {
      display: none;
    }

    .tickets-container.active {
      display: block;
    }

    .tickets-toolbar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 14px 16px;
      align-items: start;
      margin-bottom: 0;
    }

    .filters-card {
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    }

    .filters-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .filters-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: 0.2px;
    }

    .filters-subtitle {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }

    .filters-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 190px;
      align-self: start;
    }

    .filter-group label {
      font-size: 11px;
      color: #64748b;
      font-weight: 700;
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }

    .filter-control {
      padding: 10px 12px;
      border: 1px solid #dbe2ea;
      border-radius: 10px;
      font-size: 13px;
      background: #ffffff;
      font-family: inherit;
      letter-spacing: 0.4px;
      min-height: 40px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-control:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.18);
    }

    .filter-control::placeholder {
      color: #bbb;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .filter-inline {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .ticket-range-group {
      min-width: 420px;
      grid-column: span 2;
    }

    .range-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .range-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .range-card-title {
      font-size: 12px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: 0.3px;
    }

    .range-card-hint {
      font-size: 11px;
      color: #94a3b8;
    }

    .ticket-range-grid {
      display: grid;
      grid-template-columns: minmax(180px, 1fr) minmax(120px, 160px);
      gap: 12px;
      align-items: end;
    }

    .ticket-time-field {
      min-width: 120px;
    }

    .filter-inline .filter-control {
      flex: 1 1 0;
      min-width: 0;
      width: auto;
    }

    .ticket-date-field {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }

    .ticket-picker-trigger {
      width: 100%;
      background: #ffffff;
      border: 1px solid #dbe2ea;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 13px;
      font-family: inherit;
      color: #0f172a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      letter-spacing: 0.3px;
      min-height: 40px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
    }

    .ticket-picker-trigger:hover {
      border-color: #94a3b8;
    }

    .ticket-picker-trigger:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }

    .picker-caret {
      color: #64748b;
      font-size: 12px;
    }

    .ticket-picker {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: auto;
      width: 280px;
      max-width: 320px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 14px 34px rgba(15, 23, 42, 0.15);
      padding: 10px;
      z-index: 1200;
      display: none;
    }

    .ticket-picker.active {
      display: block;
      animation: fadeIn 0.16s ease;
    }

    .picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .picker-month {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      text-align: center;
      flex: 1;
    }

    .picker-nav {
      background: #f1f5f9;
      border: none;
      border-radius: 8px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: #0f172a;
      font-size: 16px;
    }

    .picker-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 10px;
      color: #64748b;
      text-align: center;
      margin-bottom: 6px;
    }

    .picker-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .picker-day {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: #0f172a;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .picker-day:hover {
      background: #e2e8f0;
    }

    .picker-day.selected {
      background: #2563eb;
      color: #fff;
      font-weight: 600;
    }

    .picker-day.muted {
      color: #cbd5f5;
      cursor: default;
    }

    .filter-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    .btn-secondary.btn-clear {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      color: #0f172a;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    }

    .btn-secondary.btn-clear:hover {
      background: #f8fafc;
    }

    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
      border: 1px solid #e6e9ef;
    }

    .tickets-table th {
      padding: 14px 16px;
      background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
      border-bottom: 1px solid #e6e9ef;
      text-align: left;
      font-weight: 600;
      color: #111;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .ticket-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tickets-table .btn-open-chat {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0, 168, 132, 0.25) !important;
      background: linear-gradient(180deg, #f3fbf8 0%, #e4f6f0 100%) !important;
      color: #0b6b57 !important;
      font-size: 12px !important;
      font-weight: 700 !important;
      letter-spacing: 0.2px !important;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease, background 0.2s, border-color 0.2s, color 0.2s;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0, 168, 132, 0.12) !important;
    }

    .tickets-table .btn-open-chat::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00a884 !important;
      box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.15);
    }

    .tickets-table .btn-open-chat:hover {
      background: linear-gradient(180deg, #e9f9f3 0%, #dff5ee 100%) !important;
      border-color: rgba(0, 168, 132, 0.45) !important;
      color: #0a5e4c !important;
      box-shadow: 0 6px 14px rgba(0, 168, 132, 0.18) !important;
      transform: translateY(-1px);
    }

    .btn-open-chat:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(16, 185, 129, 0.14);
    }

    .btn-open-chat:focus-visible {
      outline: 2px solid #0ea5e9;
      outline-offset: 2px;
    }

    .tickets-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #eef1f6;
      font-size: 13px;
      color: #111;
    }

    .tickets-table tr:hover {
      background: #f7f9fc;
    }

    .tickets-table tbody tr:nth-child(even) {
      background: #fbfcfe;
    }

    .ticket-phone {
      font-weight: 600;
      color: #111;
    }

    .ticket-seller {
      color: #667781;
    }

    .ticket-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pendente {
      background: #fff3cd;
      color: #856404;
    }

    .status-em_atendimento {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-resolvido {
      background: #d4edda;
      color: #155724;
    }
    .status-encerrado {
      background: #d4edda;
      color: #155724;
    }
    .status-aguardando {
      background: #fff0e0;
      color: #7a4b00;
    }

    .assign-select {
      padding: 8px 10px;
      border: 1px solid #dbe2ea;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      background: #fff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
    }

    /* Business Hours */
    .hours-container {
      display: none;
    }

    .hours-container.active {
      display: block;
    }

    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .panel h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #111;
    }

    .hours-grid {
      display: grid;
      gap: 12px;
    }

    .hours-row {
      display: grid;
      grid-template-columns: 1fr 120px 120px 120px;
      gap: 10px;
      align-items: center;
    }

    .hours-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #111;
    }

    .hours-row input[type="time"] {
      padding: 8px 10px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
    }

    .hours-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .btn-save-hours {
      padding: 10px 16px;
      background: #00a884;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-save-hours:hover {
      background: #008f6c;
    }

    .exceptions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .exceptions-table th,
    .exceptions-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .exceptions-table th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .exception-form {
      display: grid;
      grid-template-columns: 180px 1fr 140px;
      gap: 10px;
      align-items: center;
    }

    .exception-form input,
    .exception-form button,
    .exception-form textarea {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
    }

    .exception-form button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .exception-form button:hover {
      background: #5568d3;
    }

    .btn-delete-exception {
      padding: 6px 12px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .message-textarea {
      width: 100%;
      min-height: 90px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #d1d7db;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    /* Blacklist */
    .blacklist-container {
      display: none;
    }

    .blacklist-container.active {
      display: block;
    }

    .blacklist-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .blacklist-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .blacklist-form textarea,
    .blacklist-form input {
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .blacklist-form textarea {
      grid-column: 1 / -1;
      min-height: 80px;
      resize: vertical;
    }

    .blacklist-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #111;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .blacklist-table {
      width: 100%;
      border-collapse: collapse;
    }

    .blacklist-table th,
    .blacklist-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      text-align: left;
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Toast de Alerta */
    .custom-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      max-width: 350px;
      border-left: 4px solid #00a884;
    }

    .custom-toast.error {
      border-left-color: #ff6b6b;
    }

    .custom-toast.warning {
      border-left-color: #ffa500;
    }

    .custom-toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .custom-toast-message {
      flex: 1;
      font-size: 14px;
      color: #111;
    }

    .custom-toast-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #667781;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .custom-toast.hiding {
      animation: slideOutRight 0.3s ease;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #111;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .btn-save {
      background: #667eea;
      color: white;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #111;
    }

    .btn-modal:hover {
      opacity: 0.8;
    }

    /* Ranking Section Styles */
    .ranking-filters {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .filter-presets {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .preset-btn {
      background: #00a884;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .preset-btn:hover {
      background: #008f6c;
    }

    .filter-custom {
      display: flex;
      gap: 16px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .date-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .date-input-group label {
      font-size: 14px;
      color: #667781;
      font-weight: 500;
    }

    .date-input-group input[type="date"] {
      padding: 10px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 14px;
      min-width: 160px;
    }

    .btn-filter {
      background: #00a884;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-filter:hover {
      background: #008f6c;
    }

    .ranking-loading, .ranking-empty {
      text-align: center;
      padding: 60px 20px;
      color: #667781;
    }

    .ranking-loading .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00a884;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .ranking-table th {
      background: #f8f9fa;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      color: #111;
      border-bottom: 2px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .ranking-table th.sortable:hover {
      background: #e8e8e8;
    }

    .ranking-table th.sorted::after {
      content: ' ‚Üì';
      color: #00a884;
    }

    .ranking-table th.sorted.asc::after {
      content: ' ‚Üë';
    }

    .ranking-table td {
      padding: 14px;
      border-bottom: 1px solid #f0f0f0;
      color: #111;
    }

    .ranking-table tbody tr:hover {
      background: #f8f9fa;
    }

    .ranking-position {
      font-weight: 700;
      color: #00a884;
      font-size: 16px;
    }

    .ranking-position.top3 {
      color: #f59e0b;
    }

    #rankingChart {
      max-width: 100%;
      width: 100%;
      height: 400px;
      display: block;
    }

    .panel:has(#rankingChart) {
      position: relative;
      min-height: 440px;
      background: linear-gradient(to bottom, #fafafa, #ffffff);
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .panel:has(#rankingChart) h3 {
      color: #111827;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    /* Responsividade Ranking */
    @media (max-width: 1024px) {
      .filter-custom {
        flex-direction: column;
        align-items: stretch;
      }

      .date-input-group input[type="date"] {
        width: 100%;
      }

      .btn-filter {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      #rankingChart {
        height: 300px;
      }

      .filter-presets {
        flex-direction: column;
      }

      .preset-btn {
        width: 100%;
      }

      .ranking-table {
        font-size: 14px;
      }

      .ranking-table th,
      .ranking-table td {
        padding: 10px 8px;
      }
    }

    @media (max-width: 480px) {
      #rankingChart {
        height: 250px;
      }

      .ranking-table {
        font-size: 12px;
      }

      .ranking-table th,
      .ranking-table td {
        padding: 8px 6px;
      }
    }

    /* Responsividade Mobile (drawer + layout touch-friendly) */
    @media (max-width: 768px) {
      body {
        overflow: hidden;
      }

      .menu-btn {
        display: inline-flex;
      }

      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: min(86vw, 320px);
        border-right: none;
        transform: translateX(-105%);
        transition: transform 220ms cubic-bezier(.2,.9,.2,1);
        z-index: 1001;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 0;
        overflow-y: auto;
        border-bottom: none;
      }

      .nav-item {
        white-space: normal;
        padding: 12px 16px;
        border-right: 3px solid transparent;
        border-bottom: none;
        border-radius: 0;
      }

      .nav-item.active {
        border-right-color: #00a884;
        border-bottom-color: transparent;
      }

      .main-content {
        width: 100%;
      }

      .header {
        padding: 12px 14px;
        position: sticky;
        top: 0;
        z-index: 20;
      }

      .header h1 {
        font-size: 18px;
      }

      .content {
        padding: 14px;
      }

      .tickets-toolbar {
        grid-template-columns: 1fr;
      }

      .filter-group {
        min-width: 0;
      }

      .filter-actions {
        margin-left: 0;
      }

      .ticket-range-group {
        min-width: 0;
        grid-column: auto;
      }

      .ticket-range-grid {
        grid-template-columns: 1fr 1fr;
      }

      .filters-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters-actions {
        width: 100%;
      }

      .filters-actions .btn-clear {
        width: 100%;
      }

      .ticket-date-field {
        min-width: 0;
      }

      .ticket-picker {
        position: static;
        width: 100%;
        max-width: none;
        margin-top: 6px;
      }

      .sellers-grid {
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .seller-card {
        padding: 16px;
      }

      .seller-actions {
        flex-direction: column;
      }

      .btn-small {
        padding: 10px 12px;
        font-size: 13px;
      }

      .blacklist-form {
        grid-template-columns: 1fr;
      }

      .blacklist-actions {
        flex-direction: column;
      }

      .exception-form {
        grid-template-columns: 1fr;
      }

      .exception-form button {
        width: 100%;
      }

      .hours-row {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "day toggle"
          "open close";
        gap: 10px;
      }

      .hours-row .hours-day {
        grid-area: day;
        font-weight: 600;
        color: #111;
      }

      .hours-row label {
        grid-area: toggle;
        justify-content: flex-end;
      }

      .hours-row input[data-field="open_time"] {
        grid-area: open;
      }

      .hours-row input[data-field="close_time"] {
        grid-area: close;
      }

      .table-scroll table {
        min-width: 720px;
      }

      .modal-content {
        width: min(96vw, 520px);
        padding: 18px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .custom-toast {
        left: 12px;
        right: 12px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .sidebar-header {
        padding: 16px;
      }

      .header h1 {
        font-size: 16px;
      }

      .btn-new-seller {
        padding: 10px 12px;
        font-size: 13px;
      }

      .panel {
        padding: 16px;
      }
    }
  </style>
  <link rel="stylesheet" href="/ui.css">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="container">
  <script src="/config.js"></script>
  <script src="/ui.js"></script>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Admin</h2>
        <p style="font-size: 12px; opacity: 0.9;" id="adminName">Admin</p>
      </div>

      <div class="sidebar-nav">
        <div class="nav-item active" data-section="sellers" onclick="showSection('sellers')">
          <span>üë®‚Äçüíº</span>
          Usu√°rios
        </div>

        
        <div class="nav-item" data-section="tickets" onclick="showSection('tickets')">
          <span>üìã</span>
          Tickets
        </div>
        <div class="nav-item" data-section="blacklist" onclick="showSection('blacklist')">
          <span>üö´</span>
          Blacklist
        </div>
        <div class="nav-item" data-section="hours" onclick="showSection('hours')">
          <span>üóìÔ∏è</span>
          Hor√°rios de Funcionamento
        </div>
        <div class="nav-item" data-section="await" onclick="showSection('await')">
          <span>‚è≥</span>
          Aguardando autom√°tico
        </div>
        <div class="nav-item" data-section="ranking" onclick="showSection('ranking')">
          <span>üèÜ</span>
          Ranking de Vendedores
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="back-btn" onclick="goBackToChats()">‚Üê Voltar aos Chats</button>
        <button class="whatsapp-logout-btn" onclick="disconnectWhatsApp()">Desconectar WhatsApp</button>
        <button class="logout-btn" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <div class="header-left">
          <button class="menu-btn" id="menuBtn" type="button" aria-label="Abrir menu" onclick="toggleSidebar()">‚ò∞</button>
          <h1 id="sectionTitle">Gerenciar Vendedores</h1>
        </div>
        <button id="headerBtn" class="btn-new-seller" onclick="openNewSellerModal()">+ Novo Usu√°rio</button>
      </div>

      <div class="content">
        <!-- Sellers Section -->
        <div class="sellers-container active" id="sellersSection">
          <div id="sellersList"></div>
        </div>

        <!-- Tickets Section -->
        <div class="tickets-container" id="ticketsSection">
          <div class="panel">
            <div class="filters-card">
              <div class="filters-header">
                <div>
                  <div class="filters-title">Filtros de tickets</div>
                  <div class="filters-subtitle">Refine a lista por vendedor, status e per√≠odo</div>
                </div>
                <div class="filters-actions">
                  <button class="btn-secondary btn-clear" type="button" onclick="clearTicketFilters()">Limpar filtros</button>
                </div>
              </div>

              <div class="tickets-toolbar">
                <div class="filter-group">
                  <label for="ticketSellerFilter">Vendedor</label>
                  <select id="ticketSellerFilter" class="filter-control" onchange="applyTicketFilters()"></select>
                </div>

                <div class="filter-group">
                  <label for="ticketTimePreset">Per√≠odo</label>
                  <select id="ticketTimePreset" class="filter-control" onchange="applyTicketTimePreset()">
                    <option value="">Qualquer data</option>
                    <option value="today">Hoje</option>
                    <option value="yesterday">Ontem</option>
                    <option value="last_24h">√öltimas 24 horas</option>
                    <option value="last_7d">√öltimos 7 dias</option>
                    <option value="last_30d">√öltimos 30 dias</option>
                    <option value="this_month">Este m√™s</option>
                    <option value="prev_month">M√™s passado</option>
                    <option value="custom">Personalizado</option>
                  </select>
                </div>

                <div class="filter-group ticket-range-group range-card">
                  <div class="range-card-header">
                    <span class="range-card-title">Atualizado entre</span>
                    <span class="range-card-hint">DD/MM/AAAA</span>
                  </div>
                  <div class="filter-inline ticket-range-grid">
                    <div style="flex: 1; min-width: 130px;">
                      <label style="font-size: 0.85em; color: #667781;">De</label>
                      <div class="ticket-date-field">
                        <button type="button" class="ticket-picker-trigger" id="ticketFromDateTrigger" aria-label="Selecionar data inicial">
                          <span id="ticketFromDateDisplay">Selecionar data</span>
                          <span class="picker-caret">‚ñæ</span>
                        </button>
                        <input id="ticketUpdatedFrom" type="hidden" />
                        <div class="ticket-picker" id="ticketFromDatePicker" aria-hidden="true">
                          <div class="picker-header">
                            <button type="button" class="picker-nav" id="ticketFromPrevMonth">‚Äπ</button>
                            <div class="picker-month" id="ticketFromMonthLabel"></div>
                            <button type="button" class="picker-nav" id="ticketFromNextMonth">‚Ä∫</button>
                          </div>
                          <div class="picker-weekdays">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span>
                          </div>
                          <div class="picker-days" id="ticketFromCalendarDays"></div>
                        </div>
                      </div>
                    </div>
                    <div class="ticket-time-field">
                      <label style="font-size: 0.85em; color: #667781;">Hora</label>
                      <input id="ticketUpdatedFromTime" class="filter-control" type="time" aria-label="Atualizado de (hora)" oninput="onTicketTimeRangeInputChanged()" />
                    </div>
                    <div style="flex: 1; min-width: 130px;">
                      <label style="font-size: 0.85em; color: #667781;">At√©</label>
                      <div class="ticket-date-field">
                        <button type="button" class="ticket-picker-trigger" id="ticketToDateTrigger" aria-label="Selecionar data final">
                          <span id="ticketToDateDisplay">Selecionar data</span>
                          <span class="picker-caret">‚ñæ</span>
                        </button>
                        <input id="ticketUpdatedTo" type="hidden" />
                        <div class="ticket-picker" id="ticketToDatePicker" aria-hidden="true">
                          <div class="picker-header">
                            <button type="button" class="picker-nav" id="ticketToPrevMonth">‚Äπ</button>
                            <div class="picker-month" id="ticketToMonthLabel"></div>
                            <button type="button" class="picker-nav" id="ticketToNextMonth">‚Ä∫</button>
                          </div>
                          <div class="picker-weekdays">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span>
                          </div>
                          <div class="picker-days" id="ticketToCalendarDays"></div>
                        </div>
                      </div>
                    </div>
                    <div class="ticket-time-field">
                      <label style="font-size: 0.85em; color: #667781;">Hora</label>
                      <input id="ticketUpdatedToTime" class="filter-control" type="time" aria-label="Atualizado at√© (hora)" oninput="onTicketTimeRangeInputChanged()" />
                    </div>
                  </div>
                </div>

                <div class="filter-group">
                  <label for="ticketStatusFilter">A√ß√£o (status)</label>
                  <select id="ticketStatusFilter" class="filter-control" onchange="applyTicketFilters()">
                    <option value="">Todos</option>
                    <option value="pendente">Pendente</option>
                    <option value="em_atendimento">Em atendimento</option>
                    <option value="aguardando">Aguardando</option>
                    <option value="resolvido">Resolvido</option>
                    <option value="encerrado">Encerrado</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="table-scroll">
              <table class="tickets-table">
                <thead>
                  <tr>
                    <th>Contato</th>
                    <th>Telefone</th>
                    <th>Vendedor</th>
                    <th>Status</th>
                    <th>Atualizado em</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="ticketsTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Blacklist Section -->
        <div class="blacklist-container" id="blacklistSection">
          <div class="blacklist-grid">
            <div class="panel">
              <h3>Adicionar n√∫mero</h3>
              <form id="blacklistForm" class="blacklist-form" onsubmit="addBlacklist(event)">
                <input type="text" id="blacklistPhone" placeholder="Ex: (11) 999999999" required maxlength="15" oninput="formatPhoneInput(event)">
                <input type="text" id="blacklistReason" placeholder="Motivo (opcional)">
                <textarea id="blacklistReasonDetails" placeholder="Detalhes adicionais (opcional)"></textarea>
                <div class="blacklist-actions">
                  <button class="btn-primary" type="submit">Adicionar</button>
                  <button class="btn-secondary" type="reset">Limpar</button>
                </div>
              </form>
            </div>

            <div class="panel">
              <h3>Lista de n√∫meros bloqueados</h3>
              <div class="table-scroll">
                <table class="blacklist-table">
                  <thead>
                    <tr>
                      <th>Telefone</th>
                      <th>Motivo</th>
                      <th>Adicionado em</th>
                      <th>A√ß√£o</th>
                    </tr>
                  </thead>
                  <tbody id="blacklistTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Hours Section -->
        <div class="hours-container" id="hoursSection">
          <div class="panel">
            <h3>Mensagem autom√°tica fora do hor√°rio</h3>
            <textarea id="outOfHoursMessage" class="message-textarea" placeholder="Digite a mensagem autom√°tica..."></textarea>
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 13px; color: #667781;">
              <input type="checkbox" id="outOfHoursEnabled" checked />
              Enviar mensagem autom√°tica fora do hor√°rio
            </label>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveOutOfHoursMessage()">Salvar mensagem</button>
            </div>
          </div>

          <div class="panel">
            <h3>Hor√°rios por dia</h3>
            <div class="hours-grid" id="hoursGrid"></div>
            <div class="hours-actions">
              <button class="btn-save-hours" onclick="saveBusinessHours()">Salvar hor√°rios</button>
            </div>
          </div>
          

          <div class="panel">
            <h3>Datas de exce√ß√£o (feriados)</h3>
            <div class="exception-form">
              <input type="text" id="exceptionDate" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatExceptionDateInput(event)">
              <input type="text" id="exceptionReason" placeholder="Motivo (ex: feriado)">
              <button onclick="addException()">Adicionar</button>
            </div>
            <div class="table-scroll">
              <table class="exceptions-table">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Motivo</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="exceptionsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Await Configuration Section -->
        <div class="await-container" id="awaitSection">
          <div class="panel">
            <h3>Configura√ß√£o: Aguardando autom√°tico</h3>
            <p style="color: #667781; font-size: 13px; margin-bottom: 8px;">Defina quantos minutos de inatividade em "Em Atendimento" fazem o ticket passar automaticamente para "Aguardando".</p>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="number" id="awaitMinutes" min="0" style="width: 120px; padding: 8px; border: 1px solid #d1d7db; border-radius: 6px;" />
              <div style="flex: 1; color: #667781; font-size: 13px;">Minutos (0 para desativar)</div>
            </div>
            <div class="hours-actions" style="margin-top: 12px;">
              <button class="btn-save-hours" onclick="saveAwaitConfig()">Salvar configura√ß√£o</button>
            </div>
          </div>
        </div>

        <!-- Ranking Section -->
        <div class="ranking-container" id="rankingSection">
          <div class="panel">
            <h3>Filtros de Per√≠odo</h3>
            <div class="ranking-filters">
              <div class="filter-presets">
                <button class="preset-btn" onclick="applyRankingPreset('last7days')">√öltimos 7 dias</button>
                <button class="preset-btn" onclick="applyRankingPreset('last30days')">√öltimos 30 dias</button>
                <button class="preset-btn" onclick="applyRankingPreset('thisMonth')">Este m√™s</button>
              </div>
              <div class="filter-custom">
                <div class="date-input-group">
                  <label for="rankingStartDate">Data inicial:</label>
                  <input type="date" id="rankingStartDate" />
                </div>
                <div class="date-input-group">
                  <label for="rankingEndDate">Data final:</label>
                  <input type="date" id="rankingEndDate" />
                </div>
                <button class="btn-filter" onclick="loadRanking()">Filtrar</button>
              </div>
            </div>
          </div>

          <div class="ranking-loading" id="rankingLoading" style="display: none;">
            <div class="spinner"></div>
            <p>Carregando ranking...</p>
          </div>

          <div class="ranking-empty" id="rankingEmpty" style="display: none;">
            <p>üìä Nenhum ticket foi resolvido no per√≠odo selecionado.</p>
          </div>

          <div id="rankingContent" style="display: none;">
            <div class="panel">
              <h3>Gr√°fico de Ranking</h3>
              <canvas id="rankingChart"></canvas>
            </div>

            <div class="panel">
              <h3>Tabela de Resultados</h3>
              <div class="table-scroll">
                <table class="ranking-table">
                  <thead>
                    <tr>
                      <th onclick="sortRankingTable('position')" class="sortable">Posi√ß√£o</th>
                      <th onclick="sortRankingTable('name')" class="sortable">Nome</th>
                      <th onclick="sortRankingTable('resolved')" class="sortable">Tickets Resolvidos</th>
                      <th onclick="sortRankingTable('percent')" class="sortable">% de Tickets</th>
                    </tr>
                  </thead>
                  <tbody id="rankingTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para criar/editar vendedor -->
  <div class="modal" id="sellerModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Novo Usu√°rio</div>
      
      <form id="sellerForm" onsubmit="saveSeller(event)">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="sellerName" required>
        </div>

        <div class="form-group">
          <label>Senha *</label>
          <input type="password" id="sellerPassword" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-modal btn-cancel" onclick="closeSellerModal()">Cancelar</button>
          <button type="submit" class="btn-modal btn-save">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header" id="confirmTitle">Confirmar a√ß√£o</div>
      <p id="confirmMessage" style="margin-bottom: 20px; color: #667781; font-size: 14px;"></p>
      <div class="modal-actions">
        <button type="button" class="btn-modal btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
        <button type="button" class="btn-modal btn-save" onclick="confirmModalAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Desconectar WhatsApp -->
  <div class="modal" id="disconnectModal">
    <div class="modal-content">
      <div class="modal-header">Desconectar WhatsApp</div>
      <p style="margin-bottom: 16px; color: #667781; font-size: 14px;">Deseja desconectar o WhatsApp desta conta?</p>
      <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 13px; color: #111;">
        <input type="checkbox" id="disconnectDeleteDb" />
        Apagar banco de dados deste n√∫mero
      </label>
      <div class="modal-actions">
        <button type="button" class="btn-modal btn-cancel" onclick="closeDisconnectModal()">Cancelar</button>
        <button type="button" class="btn-modal btn-save" onclick="confirmDisconnectWhatsApp()">Desconectar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Alterar Senha -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <div class="modal-header">üîê Alterar Senha</div>
      <p id="changePasswordUserName" style="margin-bottom: 20px; color: #667781; font-size: 14px;"></p>
      <form id="changePasswordForm" style="margin-bottom: 20px;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; color: #111; font-weight: 500; font-size: 14px;">Nova Senha</label>
          <input 
            type="password" 
            id="newPassword" 
            placeholder="Digite a nova senha"
            style="width: 100%; padding: 10px 12px; border: 1px solid #d1d7db; border-radius: 6px; font-size: 14px; font-family: inherit;"
            required
          >
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; color: #111; font-weight: 500; font-size: 14px;">Confirmar Senha</label>
          <input 
            type="password" 
            id="confirmPassword" 
            placeholder="Confirme a nova senha"
            style="width: 100%; padding: 10px 12px; border: 1px solid #d1d7db; border-radius: 6px; font-size: 14px; font-family: inherit;"
            required
          >
        </div>
        <div id="changePasswordError" style="color: #d32f2f; font-size: 13px; margin-bottom: 15px; display: none;"></div>
      </form>
      <div class="modal-actions">
        <button type="button" class="btn-modal btn-cancel" onclick="closeChangePasswordModal()">Cancelar</button>
        <button type="button" class="btn-modal btn-save" onclick="submitChangePassword()">Alterar Senha</button>
      </div>
    </div>
  </div>

  <script>
    // Use URLs relativas para evitar problemas de protocolo (http/https) e CORS.
    const API_URL = window.API_BASE || '';

    // Helper para formatar mensagens de erro com detalhes
    function formatErrorMessage(data) {
      if (!data) return 'Erro desconhecido';
      if (data.details && Array.isArray(data.details)) {
        // Remove o prefixo "campo: " de cada mensagem
        return data.details.map(msg => {
          const colonIndex = msg.indexOf(':');
          return colonIndex > 0 ? msg.substring(colonIndex + 1).trim() : msg;
        }).join('; ');
      }
      if (data.details && typeof data.details === 'string') {
        // Remove o prefixo "campo: " se existir
        const colonIndex = data.details.indexOf(':');
        return colonIndex > 0 ? data.details.substring(colonIndex + 1).trim() : data.details;
      }
      return data.error || 'Erro desconhecido';
    }

    let sellers = [];
    let tickets = [];
    let editingId = null;
    let businessHours = [];
    let exceptions = [];
    const DAYS = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    let blacklist = [];
    let confirmCallback = null;

    const UNASSIGNED_FILTER = '__unassigned__';
    let ticketFiltersDebounceTimer = null;

    function pad2(n) {
      return String(n).padStart(2, '0');
    }

    function toDateTimeLocalValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Usa hor√°rio local do browser (brasileiro)
      const year = date.getFullYear();
      const month = pad2(date.getMonth() + 1);
      const day = pad2(date.getDate());
      const hours = pad2(date.getHours());
      const minutes = pad2(date.getMinutes());
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function toDateValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Retorna DD/MM/YYYY para input text
      const day = pad2(date.getDate());
      const month = pad2(date.getMonth() + 1);
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function toTimeValue(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      // Retorna HH:mm para input type="time"
      const hours = pad2(date.getHours());
      const minutes = pad2(date.getMinutes());
      return `${hours}:${minutes}`;
    }

    function formatDateBR(input) {
      // Extrair apenas n√∫meros que est√£o no input
      let rawValue = input.value.replace(/\D/g, '');
      
      // Limitar a 8 d√≠gitos (DD+MM+YYYY)
      rawValue = rawValue.substring(0, 8);
      
      // Construir o valor formatado
      let formatted = '';
      
      if (rawValue.length > 0) {
        formatted = rawValue.substring(0, 2);
      }
      if (rawValue.length > 2) {
        formatted += '/' + rawValue.substring(2, 4);
      }
      if (rawValue.length > 4) {
        formatted += '/' + rawValue.substring(4, 8);
      }
      
      // Atualizar o valor do input
      input.value = formatted;
    }
    
    function setupDateInputMask(inputSelector) {
      const input = document.querySelector(inputSelector);
      if (!input) return;
      
      // Bloquear caracteres n√£o-num√©ricos em tempo real
      input.addEventListener('keypress', function(e) {
        const char = String.fromCharCode(e.which);
        if (!/[0-9]/.test(char)) {
          e.preventDefault();
          return false;
        }
      });
      
      // Formatar ao digitar
      input.addEventListener('input', function(e) {
        formatDateBR(this);
        // Disparar evento de mudan√ßa personalizado para os filtros
        if (onTicketTimeRangeInputChanged) {
          setTimeout(() => onTicketTimeRangeInputChanged(), 10);
        }
      });
      
      // Permitir paste
      input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        // Extrair apenas n√∫meros do paste
        const numbersOnly = pastedText.replace(/\D/g, '');
        this.value = numbersOnly;
        formatDateBR(this);
        if (onTicketTimeRangeInputChanged) {
          setTimeout(() => onTicketTimeRangeInputChanged(), 10);
        }
      });
    }

    function dateStringBRToISO(dateStr) {
      // Converte DD/MM/YYYY para YYYY-MM-DD
      if (!dateStr || dateStr.length !== 10) return null;
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      const dd = parts[0];
      const mm = parts[1];
      const yyyy = parts[2];
      if (!/^\d{2}$/.test(dd) || !/^\d{2}$/.test(mm) || !/^\d{4}$/.test(yyyy)) return null;
      return `${yyyy}-${mm}-${dd}`;
    }

    const ticketDatePickerState = {
      open: null,
      from: { month: new Date(), selectedDate: null },
      to: { month: new Date(), selectedDate: null },
    };
    let ticketDatePickersReady = false;

    function formatTicketDateDisplay(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'Selecionar data';
      return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function parseTicketDateValue(value) {
      if (!value) return null;
      const iso = dateStringBRToISO(value);
      if (!iso) return null;
      const d = new Date(`${iso}T00:00:00`);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function getTicketPickerIds(key) {
      return key === 'to'
        ? {
            trigger: 'ticketToDateTrigger',
            display: 'ticketToDateDisplay',
            input: 'ticketUpdatedTo',
            picker: 'ticketToDatePicker',
            prev: 'ticketToPrevMonth',
            next: 'ticketToNextMonth',
            label: 'ticketToMonthLabel',
            days: 'ticketToCalendarDays',
          }
        : {
            trigger: 'ticketFromDateTrigger',
            display: 'ticketFromDateDisplay',
            input: 'ticketUpdatedFrom',
            picker: 'ticketFromDatePicker',
            prev: 'ticketFromPrevMonth',
            next: 'ticketFromNextMonth',
            label: 'ticketFromMonthLabel',
            days: 'ticketFromCalendarDays',
          };
    }

    function renderTicketCalendar(key) {
      const ids = getTicketPickerIds(key);
      const label = document.getElementById(ids.label);
      const daysContainer = document.getElementById(ids.days);
      if (!label || !daysContainer) return;

      const monthDate = ticketDatePickerState[key].month;
      const year = monthDate.getFullYear();
      const month = monthDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startWeekday = firstDay.getDay();

      label.textContent = firstDay.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      daysContainer.innerHTML = '';

      for (let i = 0; i < startWeekday; i++) {
        const spacer = document.createElement('div');
        spacer.className = 'picker-day muted';
        daysContainer.appendChild(spacer);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'picker-day';
        btn.textContent = String(day);
        const date = new Date(year, month, day);
        if (ticketDatePickerState[key].selectedDate && date.toDateString() === ticketDatePickerState[key].selectedDate.toDateString()) {
          btn.classList.add('selected');
        }
        btn.addEventListener('click', () => {
          ticketDatePickerState[key].selectedDate = date;
          const hidden = document.getElementById(ids.input);
          const display = document.getElementById(ids.display);
          const formatted = `${pad2(day)}/${pad2(month + 1)}/${year}`;
          if (hidden) hidden.value = formatted;
          if (display) display.textContent = formatTicketDateDisplay(date);
          toggleTicketPicker(null);
          onTicketTimeRangeInputChanged();
        });
        daysContainer.appendChild(btn);
      }
    }

    function syncTicketDatePickerFromInput(key) {
      const ids = getTicketPickerIds(key);
      const hidden = document.getElementById(ids.input);
      const display = document.getElementById(ids.display);
      const value = hidden?.value || '';
      const d = parseTicketDateValue(value);
      ticketDatePickerState[key].selectedDate = d;
      if (d) {
        ticketDatePickerState[key].month = new Date(d.getFullYear(), d.getMonth(), 1);
      }
      if (display) display.textContent = formatTicketDateDisplay(d);
      renderTicketCalendar(key);
    }

    function resetTicketDatePickerDisplay(key) {
      const ids = getTicketPickerIds(key);
      const display = document.getElementById(ids.display);
      ticketDatePickerState[key].selectedDate = null;
      if (display) display.textContent = 'Selecionar data';
      renderTicketCalendar(key);
    }

    function toggleTicketPicker(which) {
      ticketDatePickerState.open = which;
      ['from', 'to'].forEach(key => {
        const ids = getTicketPickerIds(key);
        const picker = document.getElementById(ids.picker);
        if (picker) picker.classList.toggle('active', which === key);
      });
    }

    function initTicketDatePickers() {
      if (ticketDatePickersReady) return;
      ticketDatePickersReady = true;
      ['from', 'to'].forEach(key => {
        const ids = getTicketPickerIds(key);
        const trigger = document.getElementById(ids.trigger);
        const prevBtn = document.getElementById(ids.prev);
        const nextBtn = document.getElementById(ids.next);

        if (trigger) {
          trigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const next = ticketDatePickerState.open === key ? null : key;
            toggleTicketPicker(next);
          });
        }

        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            ticketDatePickerState[key].month = new Date(ticketDatePickerState[key].month.getFullYear(), ticketDatePickerState[key].month.getMonth() - 1, 1);
            renderTicketCalendar(key);
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            ticketDatePickerState[key].month = new Date(ticketDatePickerState[key].month.getFullYear(), ticketDatePickerState[key].month.getMonth() + 1, 1);
            renderTicketCalendar(key);
          });
        }

        syncTicketDatePickerFromInput(key);
      });

      document.addEventListener('click', (event) => {
        const fromPicker = document.getElementById('ticketFromDatePicker');
        const toPicker = document.getElementById('ticketToDatePicker');
        const fromTrigger = document.getElementById('ticketFromDateTrigger');
        const toTrigger = document.getElementById('ticketToDateTrigger');
        if (!fromPicker || !toPicker) return;
        if (fromPicker.contains(event.target) || toPicker.contains(event.target) || fromTrigger?.contains(event.target) || toTrigger?.contains(event.target)) {
          return;
        }
        toggleTicketPicker(null);
      });
    }

    function startOfDay(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfDay(date) {
      const d = new Date(date);
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function startOfMonth(date) {
      const d = new Date(date);
      d.setDate(1);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfMonth(date) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + 1, 0);
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function isMobileLayout() {
      return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
    }

    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) sidebar.classList.add('open');
      if (overlay) overlay.classList.add('active');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) sidebar.classList.remove('open');
      if (overlay) overlay.classList.remove('active');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      if (sidebar.classList.contains('open')) closeSidebar();
      else openSidebar();
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    window.addEventListener('resize', () => {
      if (!isMobileLayout()) closeSidebar();
    });

    // Verificar autentica√ß√£o via sess√£o
    async function checkAuth() {
      try {
        const response = await fetch(`${API_URL}/auth/session`, {
          credentials: 'include'
        });

        if (!response.ok) {
          if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
          return;
        }

        const data = await response.json();
        
        if (data.userType !== 'admin') {
          if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
          return;
        }

        document.getElementById('adminName').textContent = data.userName;
      } catch (error) {
        if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
      }
    }

    function openDisconnectModal() {
      const modal = document.getElementById('disconnectModal');
      const checkbox = document.getElementById('disconnectDeleteDb');
      if (checkbox) checkbox.checked = false;
      if (modal) modal.classList.add('active');
    }

    function closeDisconnectModal() {
      const modal = document.getElementById('disconnectModal');
      if (modal) modal.classList.remove('active');
    }

    async function confirmDisconnectWhatsApp() {
      const checkbox = document.getElementById('disconnectDeleteDb');
      const deleteDb = !!(checkbox && checkbox.checked);

      try {
        await fetch(`${API_URL}/whatsapp/logout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ deleteDb })
        });
      } catch (error) {
        // Ignora
      }

      try {
        await fetch(`${API_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        // Ignora
      }

      closeDisconnectModal();
      if (typeof navigateTo === 'function') navigateTo('/whatsapp-qr'); else window.location.href = '/whatsapp-qr';
    }

    async function disconnectWhatsApp() {
      openDisconnectModal();
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        // Ignora erros de logout
      }
      if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
    }

    function showSection(section) {
      // update nav active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === section);
      });

      // close drawer on mobile after selecting a section
      if (isMobileLayout()) closeSidebar();

      // graceful transition: fade out current active section, then switch
      const current = document.querySelector('[id$="Section"].active');
      const finishSwitch = () => {
        document.querySelectorAll('[id$="Section"]').forEach(div => div.classList.remove('active'));

        if (section === 'sellers') {
          document.getElementById('sellersSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Gerenciar Usu√°rios';
          document.getElementById('headerBtn').style.display = 'block';
          document.getElementById('headerBtn').textContent = '+ Novo Usu√°rio';
          document.getElementById('headerBtn').onclick = openNewSellerModal;
          loadUsers();
        } else if (section === 'tickets') {
          document.getElementById('ticketsSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Tickets';
          document.getElementById('headerBtn').style.display = 'none';
          loadTickets();
        } else if (section === 'blacklist') {
          document.getElementById('blacklistSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Blacklist';
          document.getElementById('headerBtn').style.display = 'none';
          loadBlacklist();
        } else if (section === 'hours') {
          document.getElementById('hoursSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Hor√°rios de Funcionamento';
          document.getElementById('headerBtn').style.display = 'none';
          loadBusinessHours();
          loadExceptions();
          loadOutOfHoursMessage();
        } else if (section === 'await') {
          document.getElementById('awaitSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Aguardando autom√°tico';
          document.getElementById('headerBtn').style.display = 'none';
          loadAwaitConfig();
        } else if (section === 'ranking') {
          document.getElementById('rankingSection').classList.add('active');
          document.getElementById('sectionTitle').textContent = 'Ranking de Vendedores';
          document.getElementById('headerBtn').style.display = 'none';
          initRanking();
        }

        // reveal new active
        const newActive = document.querySelector('[id$="Section"].active');
        if (newActive) {
          newActive.classList.remove('hidden');
        }
      };

      if (current) {
        // smoothly hide
        current.classList.add('fade', 'hidden');
        setTimeout(finishSwitch, 220);
      } else {
        finishSwitch();
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/users`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          let msg = 'Erro ao carregar usu√°rios';
          if (response.status === 401) msg = 'Sess√£o expirada. Fa√ßa login novamente.';
          else if (response.status === 403) msg = 'Acesso negado. Apenas administradores.';
          else {
            try {
              const err = await response.json();
              if (err && err.error) msg = err.error;
            } catch (_) {}
          }
          console.error('Erro ao carregar usu√°rios:', response.status, msg);
          if (typeof showNotification === 'function') showNotification(msg, 'error'); else showToast(msg, 'error');
          return;
        }
        
        sellers = await response.json();
        renderUsers();
        renderTicketSellerFilterOptions();
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        if (typeof showNotification === 'function') showNotification('N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.', 'error'); else showToast('N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.', 'error');
      }
    }

    function parseDateSafe(value) {
      if (value == null || value === '') return null;
      const str = String(value).trim();
      if (!str) return null;
      // Tenta formato brasileiro: DD/MM/YYYY HH:mm:ss
      const brMatch = str.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
      if (brMatch) {
        const day = Number(brMatch[1]);
        const month = Number(brMatch[2]);
        const year = Number(brMatch[3]);
        const hh = Number(brMatch[4] || '0');
        const mm = Number(brMatch[5] || '0');
        const ss = Number(brMatch[6] || '0');
        if ([day, month, year, hh, mm, ss].every(v => Number.isFinite(v))) {
          const dBr = new Date(year, month - 1, day, hh, mm, ss, 0);
          if (!isNaN(dBr.getTime())) return dBr;
        }
      }
      // Tenta parsing direto
      let d = new Date(str);
      if (!isNaN(d.getTime())) return d;
      // Tenta com normaliza√ß√£o (espa√ßo ‚Üí T), preservando timezone quando existir
      const normalized = str.replace(/\s+/g, 'T');
      const hasTz = /Z$|[+-]\d{2}:?\d{2}$/i.test(normalized);
      if (hasTz) {
        d = new Date(normalized);
        if (!isNaN(d.getTime())) return d;
      }
      const normalizedNoMs = normalized.replace(/\.\d{3}$/i, '');
      // Sem timezone expl√≠cito: trata como UTC (SQLite CURRENT_TIMESTAMP)
      d = new Date(`${normalizedNoMs}Z`);
      if (!isNaN(d.getTime())) return d;
      // Se n√£o houver timezone, faz parse manual como hor√°rio local
      const match = normalizedNoMs.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (match) {
        const y = Number(match[1]);
        const m = Number(match[2]);
        const day = Number(match[3]);
        const hh = Number(match[4]);
        const mm = Number(match[5]);
        const ss = Number(match[6] || '0');
        if ([y, m, day, hh, mm, ss].every(v => Number.isFinite(v))) {
          d = new Date(y, m - 1, day, hh, mm, ss, 0);
          if (!isNaN(d.getTime())) return d;
        }
      }
      d = new Date(normalizedNoMs);
      if (!isNaN(d.getTime())) return d;
      return null;
    }

    function getNumericIdFromComposite(id) {
      if (id == null || id === '') return null;
      const str = String(id);
      if (str.includes('_')) {
        const parts = str.split('_');
        return parts[1] || null;
      }
      return str;
    }

    function renderTicketSellerFilterOptions() {
      const select = document.getElementById('ticketSellerFilter');
      if (!select) return;

      const prev = select.value;
      const sellersSorted = Array.isArray(sellers)
        ? [...sellers].filter(s => s?.isSeller).sort((a, b) => (a.name || '').localeCompare(b.name || ''))
        : [];

      select.innerHTML = [
        `<option value="">Todos</option>`,
        `<option value="${UNASSIGNED_FILTER}">N√£o atribu√≠do</option>`,
        ...sellersSorted.map(s => {
          // Extrai ID num√©rico do formato 'seller_X' ou 'admin_X'
          const numericId = getNumericIdFromComposite(s.id);
          return `<option value="${numericId}" data-composite-id="${s.id}">${s.name || s.id}</option>`;
        }),
      ].join('');

      if (prev && [...select.options].some(o => o.value === prev)) {
        select.value = prev;
      }
    }

    function applyTicketFiltersDebounced() {
      if (ticketFiltersDebounceTimer) clearTimeout(ticketFiltersDebounceTimer);
      ticketFiltersDebounceTimer = setTimeout(() => {
        ticketFiltersDebounceTimer = null;
        applyTicketFilters();
      }, 180);
    }

    function onTicketTimeRangeInputChanged() {
      const presetEl = document.getElementById('ticketTimePreset');
      const fromDateStr = document.getElementById('ticketUpdatedFrom')?.value || '';
      const fromTimeStr = document.getElementById('ticketUpdatedFromTime')?.value || '';
      const toDateStr = document.getElementById('ticketUpdatedTo')?.value || '';
      const toTimeStr = document.getElementById('ticketUpdatedToTime')?.value || '';
      if (presetEl) {
        if ((fromDateStr || toDateStr || fromTimeStr || toTimeStr) && presetEl.value !== 'custom') {
          presetEl.value = 'custom';
        }
        if (!fromDateStr && !toDateStr && !fromTimeStr && !toTimeStr && presetEl.value === 'custom') {
          presetEl.value = '';
        }
      }
      applyTicketFiltersDebounced();
    }

    function applyTicketTimePreset() {
      const preset = document.getElementById('ticketTimePreset')?.value || '';
      const fromDateEl = document.getElementById('ticketUpdatedFrom');
      const fromTimeEl = document.getElementById('ticketUpdatedFromTime');
      const toDateEl = document.getElementById('ticketUpdatedTo');
      const toTimeEl = document.getElementById('ticketUpdatedToTime');
      // Usa hor√°rio local do browser (brasileiro)
      const now = new Date();

      if (!fromDateEl || !toDateEl || !fromTimeEl || !toTimeEl) {
        applyTicketFilters();
        return;
      }

      if (!preset) {
        fromDateEl.value = '';
        toDateEl.value = '';
        fromTimeEl.value = '';
        toTimeEl.value = '';
        resetTicketDatePickerDisplay('from');
        resetTicketDatePickerDisplay('to');
        applyTicketFilters();
        return;
      }

      if (preset === 'custom') {
        applyTicketFilters();
        return;
      }

      let from = null;
      let to = null;

      if (preset === 'today') {
        from = startOfDay(now);
        to = endOfDay(now);
      } else if (preset === 'yesterday') {
        const y = new Date(now);
        y.setDate(y.getDate() - 1);
        from = startOfDay(y);
        to = endOfDay(y);
      } else if (preset === 'last_24h') {
        from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'last_7d') {
        from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'last_30d') {
        from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        to = now;
      } else if (preset === 'this_month') {
        from = startOfMonth(now);
        to = endOfDay(now);
      } else if (preset === 'prev_month') {
        const prev = new Date(now);
        prev.setMonth(prev.getMonth() - 1);
        from = startOfMonth(prev);
        to = endOfMonth(prev);
      }

      if (from && to) {
        fromDateEl.value = toDateValue(from);
        fromTimeEl.value = toTimeValue(from);
        toDateEl.value = toDateValue(to);
        toTimeEl.value = toTimeValue(to);
        syncTicketDatePickerFromInput('from');
        syncTicketDatePickerFromInput('to');
      }

      applyTicketFilters();
    }

    function applyTicketFilters() {
      const sellerFilter = document.getElementById('ticketSellerFilter')?.value || '';
      const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';
      const fromDateStr = document.getElementById('ticketUpdatedFrom')?.value || '';
      const fromTimeStr = document.getElementById('ticketUpdatedFromTime')?.value || '';
      const toDateStr = document.getElementById('ticketUpdatedTo')?.value || '';
      const toTimeStr = document.getElementById('ticketUpdatedToTime')?.value || '';

      // Converte DD/MM/YYYY para YYYY-MM-DD e combina com hora
      let fromMs = null;
      let toMs = null;
      let fromIso = null;
      let toIso = null;

      if (fromDateStr) {
        fromIso = dateStringBRToISO(fromDateStr);
        if (fromIso) {
          const fromDateTime = fromTimeStr ? `${fromIso}T${fromTimeStr}` : `${fromIso}T00:00`;
          const fromDate = new Date(fromDateTime);
          if (!Number.isNaN(fromDate.getTime())) fromMs = fromDate.getTime();
        }
      }

      if (toDateStr) {
        toIso = dateStringBRToISO(toDateStr);
        if (toIso) {
          const toDateTime = toTimeStr ? `${toIso}T${toTimeStr}` : `${toIso}T23:59`;
          const toDate = new Date(toDateTime);
          if (!Number.isNaN(toDate.getTime())) toMs = toDate.getTime();
        }
      }

      if (fromMs != null && toMs != null && fromMs > toMs) {
        const tmp = fromMs;
        fromMs = toMs;
        toMs = tmp;
      }

      const filtered = (Array.isArray(tickets) ? tickets : []).filter(t => {
        if (sellerFilter) {
          if (sellerFilter === UNASSIGNED_FILTER) {
            // N√£o atribu√≠do: seller_id deve ser null/undefined/0/''
            if (t.seller_id != null && t.seller_id !== 0 && t.seller_id !== '') return false;
          } else {
            // Comparar como n√∫mero (backend retorna number na tabela sellers)
            const ticketSellerId = t.seller_id == null ? null : Number(t.seller_id);
            const filterSellerId = Number(sellerFilter);
            if (Number.isNaN(filterSellerId) || ticketSellerId !== filterSellerId) return false;
          }
        }

        if (statusFilter) {
          const ticketStatus = String(t.status || '').trim().toLowerCase().replace(/\s+/g, '_');
          const filterStatus = String(statusFilter).trim().toLowerCase().replace(/\s+/g, '_');
          if (ticketStatus !== filterStatus) return false;
        }

        if (fromMs != null || toMs != null) {
          const d = parseDateSafe(t.updated_at);
          if (!d) {
            const raw = String(t.updated_at || '').trim();
            const datePart = raw ? raw.slice(0, 10) : '';
            let normalizedDatePart = '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(datePart)) {
              normalizedDatePart = datePart;
            } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(datePart)) {
              normalizedDatePart = dateStringBRToISO(datePart) || '';
            }
            if (normalizedDatePart && fromIso && toIso) {
              if (normalizedDatePart < fromIso || normalizedDatePart > toIso) return false;
            } else if (normalizedDatePart && fromIso) {
              if (normalizedDatePart < fromIso) return false;
            } else if (normalizedDatePart && toIso) {
              if (normalizedDatePart > toIso) return false;
            } else {
              return false;
            }
          } else {
            const ts = d.getTime();
            if (fromMs != null && ts < fromMs) return false;
            if (toMs != null && ts > toMs) return false;
          }
        }

        return true;
      }).sort((a, b) => {
        const da = parseDateSafe(a.updated_at)?.getTime() || 0;
        const dbb = parseDateSafe(b.updated_at)?.getTime() || 0;
        return dbb - da;
      });

      const hasActiveFilters = !!(sellerFilter || statusFilter || fromMs != null || toMs != null);
      renderTickets(filtered, { filtered: hasActiveFilters });
    }

    function clearTicketFilters() {
      const sellerEl = document.getElementById('ticketSellerFilter');
      const statusEl = document.getElementById('ticketStatusFilter');
      const presetEl = document.getElementById('ticketTimePreset');
      const fromDateEl = document.getElementById('ticketUpdatedFrom');
      const fromTimeEl = document.getElementById('ticketUpdatedFromTime');
      const toDateEl = document.getElementById('ticketUpdatedTo');
      const toTimeEl = document.getElementById('ticketUpdatedToTime');
      if (sellerEl) sellerEl.value = '';
      if (statusEl) statusEl.value = '';
      if (presetEl) presetEl.value = '';
      if (fromDateEl) fromDateEl.value = '';
      if (fromTimeEl) fromTimeEl.value = '';
      if (toDateEl) toDateEl.value = '';
      if (toTimeEl) toTimeEl.value = '';
      resetTicketDatePickerDisplay('from');
      resetTicketDatePickerDisplay('to');
      applyTicketFilters();
    }

    function formatCreatedAt(value) {
      if (value == null || value === '') return '‚Äî';
      const str = String(value).trim();
      if (!str) return '‚Äî';
      const normalized = str.replace(' ', 'T').replace(/\.\d{3}Z?$/i, '');
      let d = new Date(normalized);
      if (isNaN(d.getTime())) d = new Date(str);
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function renderUsers() {
      const container = document.getElementById('sellersList');
      
      if (sellers.length === 0) {
        container.innerHTML = '<p style="color: #667781; text-align: center;">Nenhum usu√°rio cadastrado</p>';
        return;
      }

      container.innerHTML = sellers.map(user => {
        const type = [];
        if (user.isAdmin) type.push('üëë Admin');
        if (user.isSeller) type.push('üë®‚Äçüíº Vendedor');
        const typeText = type.length > 0 ? type.join(' ‚Ä¢ ') : 'Sem papel';
        
        return `
        <div class="seller-card">
          <div class="seller-header">
            <div class="seller-name">${user.name}</div>
            <div class="seller-status ${(user.isAdmin || (user.isSeller && user.sellerActive)) ? 'status-active' : 'status-inactive'}">
              ${typeText}
            </div>
          </div>
          <div class="seller-info">
            Criado em: ${formatCreatedAt(user.created_at)}
          </div>
          <div class="seller-actions">
            <button class="btn-small btn-edit" onclick="openChangePasswordModal('${user.id}', '${(user.name || '').replace(/'/g, "\\'")}')">üîê Alterar Senha</button>
            ${!user.isAdmin && user.isSeller ? `<button class="btn-small btn-edit" onclick="makeAdminSeller('${user.id}', '${(user.name || '').replace(/'/g, "\\'")}')">üëë Fazer Admin</button>` : ''}
            ${!user.isAdmin && !user.isSeller ? `<button class="btn-small btn-edit" onclick="makeAdminUser('${(user.name || '').replace(/'/g, "\\'")}')">üëë Fazer Admin</button>` : ''}
            ${user.isAdmin && !user.isSeller ? `<button class="btn-small btn-edit" onclick="revertToSeller('${(user.name || '').replace(/'/g, "\\'")}')">üë®‚Äçüíº Tornar apenas vendedor</button>` : ''}
            ${user.isAdmin && user.isSeller ? `<button class="btn-small btn-edit" onclick="revertToSeller('${(user.name || '').replace(/'/g, "\\'")}')">üë®‚Äçüíº Tornar apenas vendedor</button>` : ''}
            ${user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerAdmin('${(user.name || '').replace(/'/g, "\\'")}')">‚ùå Remover Vendedor</button>` : ''}
            ${!user.isAdmin && user.isSeller ? `<button class="btn-small btn-delete" onclick="removeSellerOnly('${user.id || ''}', '${(user.name || '').replace(/'/g, "\\'")}')">‚ùå Remover</button>` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    async function loadTickets() {
      try {
        if (!Array.isArray(sellers) || sellers.length === 0) {
          await loadUsers();
        }
        const response = await fetch(`${API_URL}/admin/tickets?includeAll=1`, {
          credentials: 'include'
        });
        tickets = await response.json();
        renderTicketSellerFilterOptions();
        applyTicketFilters();
      } catch (error) {
        // Erro ao carregar tickets
      }
    }

    function renderTickets(list = tickets, { filtered = false } = {}) {
      const tbody = document.getElementById('ticketsTableBody');
      
      const items = Array.isArray(list) ? list : [];
      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #667781;">${filtered ? 'Nenhum ticket para este filtro' : 'Nenhum ticket'}</td></tr>`;
        return;
      }

      tbody.innerHTML = items.map(ticket => `
        <tr>
          <td>${ticket.contact_name || '-'}</td>
          <td class="ticket-phone">${ticket.phone}</td>
          <td class="ticket-seller">${ticket.seller_name || 'N√£o atribu√≠do'}</td>
          <td><span class="ticket-status status-${ticket.status}">${ticket.status.replace('_', ' ')}</span></td>
          <td>${new Date(ticket.updated_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
          <td>
            <div class="ticket-actions">
              <button class="btn-open-chat" type="button" onclick="openTicketConversation(${ticket.id})">Abrir conversa</button>
              <select class="assign-select" onchange="assignTicket(${ticket.id}, this.value)">
                <option value="">Atribuir...</option>
                <option value="0" ${!ticket.seller_id ? 'selected' : ''}>N√£o atribu√≠do</option>
                ${sellers
                  .filter(s => s?.isSeller)
                  .map(s => {
                    const numericId = getNumericIdFromComposite(s.id);
                    const selected = (ticket.seller_id != null && numericId != null)
                      ? Number(ticket.seller_id) === Number(numericId)
                      : false;
                    return `<option value="${numericId}" ${selected ? 'selected' : ''}>${s.name}</option>`;
                  })
                  .join('')}
              </select>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openTicketConversation(ticketId) {
      const id = Number(ticketId);
      if (!id || Number.isNaN(id)) {
        showToast('Ticket inv√°lido', 'error');
        return;
      }
      const url = `/agent?ticketId=${encodeURIComponent(String(id))}&from=admin`;
      window.open(url, '_blank', 'noopener');
    }

    async function loadBusinessHours() {
      try {
        const response = await fetch(`${API_URL}/business-hours`, {
          credentials: 'include'
        });
        businessHours = await response.json();
        renderBusinessHours();
      } catch (error) {
        // Erro ao carregar hor√°rios
      }
    }

    function renderBusinessHours() {
      const grid = document.getElementById('hoursGrid');
      const ordered = [...businessHours].sort((a, b) => a.day - b.day);

      if (!ordered.length) {
        grid.innerHTML = '<p style="color: #667781;">Nenhum hor√°rio configurado.</p>';
        return;
      }

      grid.innerHTML = ordered.map(item => `
        <div class="hours-row">
          <div class="hours-day">${DAYS[item.day]}</div>
          <label>
            <input type="checkbox" class="hours-enabled" data-day="${item.day}" ${item.enabled ? 'checked' : ''}>
            Aberto
          </label>
          <input type="time" data-day="${item.day}" data-field="open_time" value="${item.open_time || ''}">
          <input type="time" data-day="${item.day}" data-field="close_time" value="${item.close_time || ''}">
        </div>
      `).join('');

      document.querySelectorAll('.hours-enabled').forEach(cb => {
        const day = cb.dataset.day;
        const inputs = document.querySelectorAll(`input[data-day="${day}"][data-field]`);
        inputs.forEach(input => {
          input.disabled = !cb.checked;
        });
        cb.addEventListener('change', () => {
          inputs.forEach(input => {
            input.disabled = !cb.checked;
          });
        });
      });
    }

    async function saveBusinessHours() {
      try {
        const hours = DAYS.map((_, day) => {
          const enabled = document.querySelector(`.hours-enabled[data-day="${day}"]`)?.checked;
          const open = document.querySelector(`input[data-day="${day}"][data-field="open_time"]`)?.value;
          const close = document.querySelector(`input[data-day="${day}"][data-field="close_time"]`)?.value;
          return {
            day,
            enabled: !!enabled,
            open_time: open || null,
            close_time: close || null
          };
        });

        const response = await fetch(`${API_URL}/business-hours`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(hours)
        });

        if (!response.ok) throw new Error('Erro ao salvar hor√°rios');
        if (typeof showNotification === 'function') showNotification('Hor√°rios atualizados', 'info'); else showToast('Hor√°rios atualizados', 'success');
        loadBusinessHours();
      } catch (error) {
        if (typeof showNotification === 'function') showNotification(error.message, 'error'); else showToast(error.message, 'error');
      }
    }

    async function loadExceptions() {
      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          credentials: 'include'
        });
        exceptions = await response.json();
        renderExceptions();
      } catch (error) {
        // Erro ao carregar exce√ß√µes
      }
    }

    async function loadBlacklist() {
      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          credentials: 'include'
        });
        blacklist = await response.json();
        renderBlacklist();
      } catch (error) {
        showToast('Erro ao carregar blacklist', 'error');
      }
    }

    function renderBlacklist() {
      const tbody = document.getElementById('blacklistTableBody');
      if (!Array.isArray(blacklist) || blacklist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #667781;">Nenhum n√∫mero bloqueado</td></tr>';
        return;
      }

      tbody.innerHTML = blacklist.map(item => `
        <tr>
          <td>${item.phone}</td>
          <td>${item.reason || '‚Äî'}</td>
          <td>${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
          <td><button class="btn-danger" onclick="removeBlacklist('${item.phone}')">Remover</button></td>
        </tr>
      `).join('');
    }

    function normalizarTelefoneBR(telefone) {
      let numeros = telefone.replace(/\D/g, "");

      numeros = numeros.replace(/^(\d{2})9/, "$1");

      return "55" + numeros;
    }

    async function addBlacklist(event) {
      event.preventDefault();

      let phone = normalizarTelefoneBR(document.getElementById('blacklistPhone').value);
      const reason = document.getElementById('blacklistReason').value.trim();
      const details = document.getElementById('blacklistReasonDetails').value.trim();
      const fullReason = [reason, details].filter(Boolean).join(' - ');

      if (!phone.includes('@')) {
        phone = phone.replace(/\D/g, '') + '@s.whatsapp.net';
      }

      try {
        const response = await fetch(`${API_URL}/blacklist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ phone, reason: fullReason })
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(formatErrorMessage(data) || 'Erro ao adicionar');
        }

        showToast('N√∫mero adicionado com sucesso', 'success');
        document.getElementById('blacklistForm').reset();
        loadBlacklist();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function removeBlacklist(phone) {
      openConfirmModal(`Remover ${phone} da blacklist?`, async () => {
        try {
          const response = await fetch(`${API_URL}/blacklist/${encodeURIComponent(phone)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(formatErrorMessage(data) || 'Erro ao remover');
          }

          showToast('N√∫mero removido com sucesso', 'success');
          loadBlacklist();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    function formatISODateBR(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(`${dateStr}T00:00:00`);
      return date.toLocaleDateString('pt-BR');
    }

    // Formata o input enquanto o usu√°rio digita: dd/mm/aaaa
    function formatExceptionDateInput(event) {
      const el = event.target;
      let v = el.value.replace(/[^0-9]/g, '');
      if (v.length > 8) v = v.slice(0,8);
      if (v.length >= 5) el.value = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
      else if (v.length >= 3) el.value = v.slice(0,2) + '/' + v.slice(2);
      else el.value = v;
    }

    // Formata o input enquanto o usu√°rio digita: (85) 99999-9999
    function formatPhoneInput(event) {
      const el = event.target;
      let v = el.value.replace(/\D/g, '');
      if (v.length > 11) v = v.slice(0,11);
      if (v.length > 6) el.value = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
      else if (v.length > 2) el.value = `(${v.slice(0,2)}) ${v.slice(2)}`;
      else if (v.length > 0) el.value = `(${v}`;
    }

    // Converte dd/mm/aaaa para ISO (aaaa-mm-dd). Retorna null se inv√°lido.
    function parseDateBR(value) {
      if (!value) return null;
      const trimmed = value.trim();
      // aceita dd/mm/aaaa
      const m = trimmed.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10);
        const year = parseInt(m[3], 10);
        if (month < 1 || month > 12) return null;
        const maxDay = new Date(year, month, 0).getDate();
        if (day < 1 || day > maxDay) return null;
        // return ISO
        const mm = String(month).padStart(2, '0');
        const dd = String(day).padStart(2, '0');
        return `${year}-${mm}-${dd}`;
      }

      // aceita ISO aaaa-mm-dd
      const iso = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (iso) {
        return trimmed;
      }

      return null;
    }

    function renderExceptions() {
      const tbody = document.getElementById('exceptionsTableBody');
      if (!exceptions.length) {
        tbody.innerHTML = '<tr><td colspan="3" style="color: #667781; text-align: center;">Nenhuma exce√ß√£o cadastrada</td></tr>';
        return;
      }

      tbody.innerHTML = exceptions.map(ex => `
        <tr>
          <td>${formatISODateBR(ex.date)}</td>
          <td>${ex.reason || '-'}</td>
          <td><button class="btn-delete-exception" onclick="deleteException(${ex.id})">Remover</button></td>
        </tr>
      `).join('');
    }

    async function addException() {
      const dateInput = document.getElementById('exceptionDate').value.trim();
      const reason = document.getElementById('exceptionReason').value;

      if (!dateInput) {
        showToast('Informe uma data', 'warning');
        return;
      }

      const isoDate = parseDateBR(dateInput);
      if (!isoDate) {
        showToast('Data inv√°lida. Use dd/mm/aaaa', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-exceptions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ date: isoDate, closed: true, reason })
        });

        if (!response.ok) throw new Error('Erro ao salvar exce√ß√£o');

        document.getElementById('exceptionDate').value = '';
        document.getElementById('exceptionReason').value = '';
        loadExceptions();
        showToast('Exce√ß√£o adicionada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteException(id) {
      openConfirmModal('Remover esta exce√ß√£o?', async () => {
        try {
          const response = await fetch(`${API_URL}/business-exceptions/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover exce√ß√£o');
          loadExceptions();
          showToast('Exce√ß√£o removida', 'success');
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function loadOutOfHoursMessage() {
      try {
        const response = await fetch(`${API_URL}/business-message`, {
          credentials: 'include'
        });
        const data = await response.json();
        document.getElementById('outOfHoursMessage').value = data.message || '';
        const enabledEl = document.getElementById('outOfHoursEnabled');
        if (enabledEl) enabledEl.checked = data.enabled !== false;
      } catch (error) {
        // Erro ao carregar mensagem
      }
    }

    async function saveOutOfHoursMessage() {
      const message = document.getElementById('outOfHoursMessage').value.trim();
      const enabledEl = document.getElementById('outOfHoursEnabled');
      const enabled = enabledEl ? !!enabledEl.checked : true;
      if (enabled && !message) {
        showToast('Digite uma mensagem', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/business-message`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ message, enabled })
        });

        if (!response.ok) throw new Error('Erro ao salvar mensagem');
        showToast('Configura√ß√£o atualizada', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Configura√ß√£o: Aguardando autom√°tico (mover de 'Em Atendimento' -> 'Aguardando')
    async function loadAwaitConfig() {
      try {
        const response = await fetch(`${API_URL}/admin/await-config`, {
          credentials: 'include'
        });
        if (!response.ok) return;
        const data = await response.json();
        const minutes = (data && typeof data.minutes === 'number') ? data.minutes : 0;
        document.getElementById('awaitMinutes').value = minutes;
      } catch (error) {
        // falha silenciosa
      }
    }

    async function saveAwaitConfig() {
      const raw = document.getElementById('awaitMinutes').value;
      const minutes = parseInt(raw, 10);
      if (Number.isNaN(minutes) || minutes < 0) {
        showToast('Informe um n√∫mero v√°lido de minutos (0 ou mais)', 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/await-config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ minutes })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || 'Erro ao salvar configura√ß√£o');
        }

        showToast('Configura√ß√£o salva', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function openNewSellerModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
      document.getElementById('sellerName').value = '';
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = true;
      document.getElementById('sellerModal').classList.add('active');
    }

    function editSeller(id, name) {
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Editar Vendedor';
      document.getElementById('sellerName').value = name;
      document.getElementById('sellerPassword').value = '';
      document.getElementById('sellerPassword').required = false;
      document.getElementById('sellerPassword').placeholder = 'Deixar em branco para manter a senha atual';
      document.getElementById('sellerModal').classList.add('active');
    }

    function closeSellerModal() {
      document.getElementById('sellerModal').classList.remove('active');
    }

    function openConfirmModal(message, onConfirm) {
      const modal = document.getElementById('confirmModal');
      const title = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const buttons = modal.querySelectorAll('.modal-actions .btn-modal');
      const cancelBtn = buttons[0];
      const confirmBtn = buttons[1];

      title.textContent = 'Confirmar a√ß√£o';
      messageEl.textContent = message;
      confirmCallback = onConfirm;
      cancelBtn.style.display = '';
      cancelBtn.textContent = 'Cancelar';
      confirmBtn.textContent = 'Confirmar';
      modal.classList.add('active');
    }

    function openAlertModal(message, titleText = 'Aten√ß√£o') {
      const modal = document.getElementById('confirmModal');
      const title = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const buttons = modal.querySelectorAll('.modal-actions .btn-modal');
      const cancelBtn = buttons[0];
      const confirmBtn = buttons[1];

      title.textContent = titleText;
      messageEl.textContent = message;
      confirmCallback = null;
      cancelBtn.style.display = 'none';
      confirmBtn.textContent = 'Entendi';
      modal.classList.add('active');
    }

    function closeConfirmModal() {
      confirmCallback = null;
      document.getElementById('confirmModal').classList.remove('active');
    }

    function confirmModalAction() {
      if (typeof confirmCallback === 'function') {
        confirmCallback();
      }
      closeConfirmModal();
    }

    async function saveSeller(event) {
      event.preventDefault();
      
      const name = document.getElementById('sellerName').value;
      const password = document.getElementById('sellerPassword').value;

      try {
        if (editingId) {
          const data = { name };
          if (password) data.password = password;
          
          const response = await fetch(`${API_URL}/sellers/${editingId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(formatErrorMessage(error) || 'Erro ao atualizar');
          }
          showToast('Vendedor atualizado com sucesso', 'success');
        } else {
          if (!password) {
            showToast('Senha √© obrigat√≥ria para Novo Usu√°rio', 'warning');
            return;
          }

          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(formatErrorMessage(error) || 'Erro ao criar');
          }
          showToast('Vendedor criado com sucesso', 'success');
        }

        closeSellerModal();
        loadUsers();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteSeller(id, name) {
      openConfirmModal(`Tem certeza que deseja deletar este vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao deletar');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminSeller(id, name) {
      const numId = (typeof id === 'string' && id.startsWith('seller_')) ? id.replace('seller_', '') : id;
      openConfirmModal(`Tornar ${name} admin? Ele deixar√° de ser vendedor e poder√° acessar a tela de administra√ß√£o.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${numId}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || 'Erro ao tornar admin');
          }
          showToast('Vendedor promovido a admin com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeAdminSeller(id, name) {
      openConfirmModal(`Remover status de admin de ${name}? Ele continuar√° como vendedor.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers/${id}/remove-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            if (response.status === 409) {
              openAlertModal(formatErrorMessage(data) || 'N√£o √© permitido remover o √∫ltimo admin do sistema.');
              return;
            }
            throw new Error(formatErrorMessage(data) || 'Erro ao remover admin');
          }
          showToast('Admin removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeAdminUser(name) {
      openConfirmModal(`Tornar ${name} admin? Ele ter√° acesso total ao sistema.`, async () => {
        try {
          const response = await fetch(`${API_URL}/sellers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, password: Math.random().toString(36).slice(2) })
          });

          if (!response.ok) throw new Error('Erro ao criar vendedor');
          
          const seller = await response.json();
          
          const response2 = await fetch(`${API_URL}/sellers/${seller.id}/make-admin`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response2.ok) throw new Error('Erro ao tornar admin');
          showToast('Admin criado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function makeSellerAdmin(name) {
      openConfirmModal(`Fazer ${name} tamb√©m ser vendedor?`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${name}/make-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao tornar vendedor');
          showToast('Vendedor adicionado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerAdmin(name) {
      openConfirmModal(`Remover ${name} de vendedor? Ele continuar√° como admin.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${encodeURIComponent(name)}/remove-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!response.ok) throw new Error('Erro ao remover vendedor');
          showToast('Vendedor removido com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function revertToSeller(name) {
      const displayName = (name || '').trim();
      openConfirmModal(`Tornar ${displayName} apenas vendedor? Ele deixar√° de ser admin e s√≥ poder√° acessar a tela de vendedor.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${encodeURIComponent(String(name))}/revert-to-seller`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            if (response.status === 409) {
              openAlertModal(formatErrorMessage(data) || 'N√£o √© permitido remover o √∫ltimo admin do sistema.');
              return;
            }
            throw new Error(formatErrorMessage(data) || 'Erro ao reverter para vendedor');
          }
          showToast(data.message || 'Usu√°rio agora √© apenas vendedor', 'success');
          if (data.sessionDestroyed) {
            if (typeof navigateTo === 'function') navigateTo('/login'); else window.location.href = '/login';
            return;
          }
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function removeSellerOnly(id, name) {
      const numId = (typeof id === 'string' && id.startsWith('seller_')) ? id.replace('seller_', '') : id;
      if (!numId) {
        showToast('ID do vendedor inv√°lido', 'error');
        return;
      }
      openConfirmModal(`Deletar vendedor ${name}? Esta a√ß√£o n√£o pode ser desfeita.`, async () => {
        try {
          const response = await fetch(`${API_URL}/users/${numId}/remove-seller-only`, {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) throw new Error(formatErrorMessage(data) || 'Erro ao deletar vendedor');
          showToast('Vendedor deletado com sucesso', 'success');
          loadUsers();
        } catch (error) {
          showToast(error.message, 'error');
        }
      });
    }

    async function assignTicket(ticketId, sellerId) {
      try {
        const normalizedSellerId = (sellerId && String(sellerId) !== '0') ? Number(sellerId) : null;
        const response = await fetch(`${API_URL}/tickets/${ticketId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sellerId: Number.isFinite(normalizedSellerId) ? normalizedSellerId : null })
        });

        if (!response.ok) throw new Error('Erro ao atribuir');
        showToast('Ticket atribu√≠do com sucesso', 'success');
        loadTickets();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function goBackToChats() {
      if (typeof navigateTo === 'function') navigateTo('/agent'); else window.location.href = '/agent';
    }

    // Sistema de Toast customizado
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `custom-toast ${type}`;

      const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
      toast.innerHTML = `
        <div class="custom-toast-icon">${icon}</div>
        <div class="custom-toast-message">${message}</div>
        <button class="custom-toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ===== RANKING DE VENDEDORES =====
    let rankingData = [];
    let rankingChart = null;
    let rankingSortColumn = 'resolved';
    let rankingSortAsc = false;

    function initRanking() {
      // Define dates padr√£o (√∫ltimos 30 dias)
      applyRankingPreset('last30days');
    }

    function applyRankingPreset(preset) {
      const now = new Date();
      let start, end;

      end = new Date(now);
      end.setHours(23, 59, 59, 999);

      if (preset === 'last7days') {
        start = new Date(end);
        start.setDate(start.getDate() - 7);
      } else if (preset === 'last30days') {
        start = new Date(end);
        start.setDate(start.getDate() - 30);
      } else if (preset === 'thisMonth') {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
      }

      start.setHours(0, 0, 0, 0);

      // Format as YYYY-MM-DD
      const formatDate = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      document.getElementById('rankingStartDate').value = formatDate(start);
      document.getElementById('rankingEndDate').value = formatDate(end);

      loadRanking();
    }

    async function loadRanking() {
      const startDate = document.getElementById('rankingStartDate').value;
      const endDate = document.getElementById('rankingEndDate').value;

      if (!startDate || !endDate) {
        showToast('Por favor, selecione as datas inicial e final', 'warning');
        return;
      }

      // Validar datas
      const start = new Date(startDate);
      const end = new Date(endDate);

      if (start > end) {
        showToast('Data inicial n√£o pode ser maior que a data final', 'error');
        return;
      }

      // Mostrar loading
      document.getElementById('rankingLoading').style.display = 'block';
      document.getElementById('rankingEmpty').style.display = 'none';
      document.getElementById('rankingContent').style.display = 'none';

      try {
        const url = `${API_URL}/admin/ranking-sellers?startDate=${startDate}&endDate=${endDate}`;
        console.log('[RANKING] Fazendo requisi√ß√£o para:', url);
        
        const response = await fetch(url, { credentials: 'include' });
        
        console.log('[RANKING] Status da resposta:', response.status);

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          console.error('[RANKING] Erro na resposta:', err);
          throw new Error(err.error || 'Erro ao carregar ranking');
        }

        const data = await response.json();
        console.log('[RANKING] Dados recebidos:', data);
        
        rankingData = data.ranking || [];
        console.log('[RANKING] Total de vendedores:', rankingData.length);

        if (rankingData.length === 0 || rankingData.every(r => r.tickets_resolved === 0)) {
          console.log('[RANKING] Nenhum ticket resolvido encontrado');
          document.getElementById('rankingLoading').style.display = 'none';
          document.getElementById('rankingEmpty').style.display = 'block';
          document.getElementById('rankingContent').style.display = 'none';
          return;
        }

        document.getElementById('rankingLoading').style.display = 'none';
        document.getElementById('rankingEmpty').style.display = 'none';
        document.getElementById('rankingContent').style.display = 'block';

        console.log('[RANKING] Renderizando tabela e gr√°fico...');
        renderRankingTable();

        // Garante que o canvas j√° tem layout (width/height) antes de desenhar
        requestAnimationFrame(() => {
          renderRankingChart();
        });

      } catch (error) {
        console.error('[RANKING] Erro ao carregar ranking:', error);
        showToast(error.message, 'error');
        document.getElementById('rankingLoading').style.display = 'none';
      }
    }

    function renderRankingTable() {
      const tbody = document.getElementById('rankingTableBody');
      tbody.innerHTML = '';

      // Calculate total for percentages
      const total = rankingData.reduce((sum, item) => sum + item.tickets_resolved, 0);

      // Sort data
      const sorted = [...rankingData].sort((a, b) => {
        let valA, valB;
        
        if (rankingSortColumn === 'position') {
          valA = rankingData.indexOf(a);
          valB = rankingData.indexOf(b);
        } else if (rankingSortColumn === 'name') {
          valA = a.seller_name || '';
          valB = b.seller_name || '';
        } else if (rankingSortColumn === 'resolved') {
          valA = a.tickets_resolved;
          valB = b.tickets_resolved;
        } else if (rankingSortColumn === 'percent') {
          valA = total > 0 ? (a.tickets_resolved / total) * 100 : 0;
          valB = total > 0 ? (b.tickets_resolved / total) * 100 : 0;
        }

        if (typeof valA === 'string') {
          return rankingSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
          return rankingSortAsc ? valA - valB : valB - valA;
        }
      });

      sorted.forEach((item, index) => {
        const percent = total > 0 ? ((item.tickets_resolved / total) * 100).toFixed(1) : 0;
        const position = index + 1;
        const positionClass = position <= 3 ? 'top3' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><span class="ranking-position ${positionClass}">${position}¬∫</span></td>
          <td>${item.seller_name || 'Sem nome'}</td>
          <td>${item.tickets_resolved}</td>
          <td>${percent}%</td>
        `;
        tbody.appendChild(row);
      });

      // Update sort indicators
      document.querySelectorAll('.ranking-table th').forEach(th => {
        th.classList.remove('sorted', 'asc');
      });
    }

    function sortRankingTable(column) {
      if (rankingSortColumn === column) {
        rankingSortAsc = !rankingSortAsc;
      } else {
        rankingSortColumn = column;
        rankingSortAsc = column === 'name'; // Name ascending by default, others descending
      }

      renderRankingTable();

      // Add sort indicator
      const headers = document.querySelectorAll('.ranking-table th');
      headers.forEach(th => {
        th.classList.remove('sorted', 'asc');
      });

      const columnMap = {
        position: 0,
        name: 1,
        resolved: 2,
        percent: 3
      };

      const headerIndex = columnMap[column];
      if (headerIndex !== undefined) {
        headers[headerIndex].classList.add('sorted');
        if (rankingSortAsc) {
          headers[headerIndex].classList.add('asc');
        }
      }
    }

    function renderRankingChart() {
      const canvas = document.getElementById('rankingChart');
      if (!canvas) {
        console.error('[RANKING] Canvas n√£o encontrado!');
        return;
      }

      // Destroy previous chart if exists
      if (rankingChart) {
        rankingChart.destroy();
        rankingChart = null;
      }

      // Filter sellers with resolved tickets and take top 10
      const dataToShow = rankingData
        .filter(item => item.tickets_resolved > 0)
        .slice(0, 10);

      console.log('[RANKING] Dados para gr√°fico:', dataToShow);
      console.log('[RANKING] N√∫mero de vendedores com tickets:', dataToShow.length);

      if (dataToShow.length === 0) {
        console.warn('[RANKING] Nenhum dado para exibir no gr√°fico');
        return;
      }

      const labels = dataToShow.map(item => item.seller_name || 'Sem nome');
      const values = dataToShow.map(item => item.tickets_resolved);

      console.log('[RANKING] Labels:', labels);
      console.log('[RANKING] Values:', values);

      // Create gradient colors with better palette
      const colors = dataToShow.map((_, index) => {
        if (index === 0) return '#f59e0b'; // Gold for 1st
        if (index === 1) return '#94a3b8'; // Silver for 2nd
        if (index === 2) return '#d97706'; // Bronze for 3rd
        return '#00a884'; // Green for others
      });

      const hoverColors = dataToShow.map((_, index) => {
        if (index === 0) return '#ea580c';
        if (index === 1) return '#64748b';
        if (index === 2) return '#b45309';
        return '#059669';
      });

      // Simple chart using Chart.js-like API if available, otherwise draw manually
      if (typeof Chart !== 'undefined') {
        console.log('[RANKING] Usando Chart.js...');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        
        // Calculate bar thickness based on number of items
        let barThickness;
        if (dataToShow.length === 1) {
          barThickness = 80; // Fixed width for single bar
        } else if (dataToShow.length <= 3) {
          barThickness = 100; // Wider bars for few items
        } else {
          barThickness = 'flex'; // Automatic sizing for many items
        }
        
        rankingChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Tickets Resolvidos',
              data: values,
              backgroundColor: colors,
              hoverBackgroundColor: hoverColors,
              borderRadius: 8,
              borderWidth: 0,
              barThickness: barThickness,
              maxBarThickness: dataToShow.length <= 3 ? 120 : 60
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: dpr,
            animation: {
              duration: 800,
              easing: 'easeInOutQuart'
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                cornerRadius: 8,
                titleColor: '#fff',
                bodyColor: '#fff',
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                displayColors: false,
                callbacks: {
                  title: (items) => items[0].label,
                  label: (item) => `${item.formattedValue} tickets resolvidos`
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 12,
                    weight: '500'
                  },
                  color: '#475569'
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  precision: 0,
                  font: {
                    size: 12
                  },
                  color: '#64748b',
                  padding: 8
                }
              }
            },
            layout: {
              padding: {
                top: 20,
                right: 10,
                bottom: 10,
                left: 10
              }
            }
          }
        });
      } else {
        console.log('[RANKING] Chart.js n√£o dispon√≠vel, usando gr√°fico simples...');
        // Simple manual bar chart (hi-dpi)
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const cssWidth = rect.width || canvas.clientWidth || canvas.offsetWidth || 600;
        const cssHeight = rect.height || canvas.clientHeight || canvas.offsetHeight || 400;

        canvas.width = Math.max(1, Math.floor(cssWidth * dpr));
        canvas.height = Math.max(1, Math.floor(cssHeight * dpr));
        canvas.style.width = cssWidth + 'px';
        canvas.style.height = cssHeight + 'px';

        const ctx = canvas.getContext('2d');
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        drawSimpleBarChart(ctx, labels, values, colors);
      }
    }

    function drawSimpleBarChart(ctx, labels, values, colors) {
      const canvas = ctx.canvas;
      // Use CSS dimensions, not physical pixels
      const width = canvas.clientWidth || canvas.offsetWidth || 600;
      const height = canvas.clientHeight || canvas.offsetHeight || 300;
      const maxValue = Math.max(...values, 1);
      
      // Calculate bar width based on available space
      const padding = 40;
      const labelSpace = 60;
      const availableWidth = width - (padding * 2);
      const barSpacing = 10;
      const numBars = labels.length;
      const barWidth = Math.max(20, Math.min(80, (availableWidth - (barSpacing * (numBars - 1))) / numBars));
      const totalBarsWidth = (barWidth * numBars) + (barSpacing * (numBars - 1));
      const startX = (width - totalBarsWidth) / 2;
      const chartHeight = height - labelSpace - 40;

      ctx.clearRect(0, 0, width, height);

      // Draw bars
      labels.forEach((label, index) => {
        const value = values[index];
        const barHeight = (value / maxValue) * chartHeight;
        const x = startX + (index * (barWidth + barSpacing));
        const y = height - barHeight - labelSpace;

        // Draw bar
        ctx.fillStyle = colors[index];
        ctx.fillRect(x, y, barWidth, barHeight);

        // Draw value on top
        ctx.fillStyle = '#111';
        ctx.font = 'bold 14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(value, x + barWidth / 2, y - 5);

        // Draw label at bottom
        ctx.save();
        ctx.translate(x + barWidth / 2, height - labelSpace + 10);
        ctx.rotate(-Math.PI / 4);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#667781';
        ctx.font = '12px sans-serif';
        ctx.fillText(label, 0, 0);
        ctx.restore();
      });
    }

    // Inicializar
    checkAuth();
    showSection('sellers');
    
    // Inicializar calend√°rio de data para filtros de tickets
    setTimeout(function() {
      initTicketDatePickers();
    }, 100);

    // ===== ALTERAR SENHA =====
    let changePasswordUserId = null;
    let changePasswordUserType = null;

    function openChangePasswordModal(userId, userName) {
      changePasswordUserId = userId;
      // Determina se √© admin ou seller baseado no ID
      changePasswordUserType = String(userId).startsWith('admin_') ? 'admin' : 'seller';
      
      document.getElementById('changePasswordUserName').textContent = `Alterar senha de: ${userName}`;
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('changePasswordError').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
      document.getElementById('changePasswordModal').classList.add('active');
      document.getElementById('newPassword').focus();
    }

    function closeChangePasswordModal() {
      changePasswordUserId = null;
      changePasswordUserType = null;
      document.getElementById('changePasswordModal').classList.remove('active');
    }

    async function submitChangePassword() {
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const errorEl = document.getElementById('changePasswordError');

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      // Valida√ß√µes
      if (!newPassword) {
        errorEl.textContent = 'Digite a nova senha';
        errorEl.style.display = 'block';
        return;
      }

      if (newPassword.length < 4) {
        errorEl.textContent = 'A senha deve ter no m√≠nimo 4 caracteres';
        errorEl.style.display = 'block';
        return;
      }

      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'As senhas n√£o conferem';
        errorEl.style.display = 'block';
        return;
      }

      try {
        // Extrair ID num√©rico do formato composto (admin_X ou seller_X)
        let numericId = changePasswordUserId;
        if (typeof numericId === 'string' && numericId.includes('_')) {
          const parts = numericId.split('_');
          numericId = parts[1];
        }
        
        const endpoint = changePasswordUserType === 'admin' 
          ? `/users/${numericId}/change-password`
          : `/sellers/${numericId}/change-password`;

        console.log('[changePassword] Enviando para:', endpoint, { newPassword: '***', numericId, userType: changePasswordUserType });

        const response = await fetch(`${API_URL}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ newPassword })
        });

        console.log('[changePassword] Status:', response.status);

        // Verificar se a resposta √© JSON antes de fazer parse
        const contentType = response.headers.get('content-type');
        let data = {};
        
        if (contentType && contentType.includes('application/json')) {
          try {
            data = await response.json();
          } catch (parseError) {
            console.error('[changePassword] Erro ao fazer parse JSON:', parseError);
            data = { error: 'Erro ao processar resposta do servidor' };
          }
        } else {
          const text = await response.text();
          console.error('[changePassword] Resposta n√£o √© JSON:', text);
          data = { error: 'Resposta do servidor inv√°lida' };
        }

        if (!response.ok) {
          throw new Error(formatErrorMessage(data) || 'Erro ao alterar senha');
        }

        showToast('Senha alterada com sucesso', 'success');
        closeChangePasswordModal();
        loadUsers();
      } catch (error) {
        console.error('[changePassword] Erro:', error);
        errorEl.textContent = error.message || 'Erro ao alterar senha';
        errorEl.style.display = 'block';
      }
    }

    // Fechar modal ao pressionar Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('changePasswordModal');
        if (modal && modal.classList.contains('active')) {
          closeChangePasswordModal();
        }
      }
    });

    // Fechar modal ao clicar fora (overlay)
    document.getElementById('changePasswordModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'changePasswordModal') {
        closeChangePasswordModal();
      }
    });
  </script>
</body>
</html>
