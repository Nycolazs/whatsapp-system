<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="color-scheme" content="light">
  <meta name="application-name" content="WhatsApp System">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WhatsApp System">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="apple-touch-icon" href="/icon-180.png">
  <!-- N√£o for√ßar downgrade para HTTP: permite operar em HTTPS quando configurado. -->
  <title>Login - WhatsApp System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 400px;
      padding: 40px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-header h1 {
      color: #111;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #667781;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #111;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #d1d7db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .password-field {
      position: relative;
    }

    .password-field input {
      padding-right: 44px;
    }

    .masked-secret {
      -webkit-text-security: disc;
      text-security: disc;
    }

    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #667781;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .password-toggle svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .password-toggle:hover {
      color: #495661;
    }

    .user-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    /* removed user type selector styles (single unified login) */

    .login-button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .login-button:hover {
      background: #5568d3;
    }

    .login-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }


    .error-message {
      color: #d32f2f;
      font-size: 14px;
      margin-bottom: 20px;
      padding: 12px;
      background: #ffebee;
      border-radius: 6px;
      display: none;
    }

    .autofill-trap {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    /* Responsividade Mobile */
    @media (max-width: 480px) {
      body {
        padding: 20px;
      }

      .login-container {
        padding: 30px 20px;
      }

      .login-header h1 {
        font-size: 24px;
      }

      .login-header p {
        font-size: 13px;
      }

      .form-group label {
        font-size: 13px;
      }

      .form-input {
        font-size: 14px;
        padding: 12px;
      }

      .login-button {
        font-size: 14px;
        padding: 12px;
      }
    }
  </style>
  <link rel="stylesheet" href="/ui.css">
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <h1>üîê Login</h1>
      <p>WhatsApp System</p>
    </div>

    <!-- user type selection removed: unified login -->

    <div id="errorMessage" class="error-message"></div>

    <form id="loginForm" autocomplete="off" novalidate data-lpignore="true">
      <input class="autofill-trap" type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true">
      <input class="autofill-trap" type="password" name="password" autocomplete="current-password" tabindex="-1" aria-hidden="true">
      <div class="form-group">
        <label for="accessKey">Usu√°rio / Nome</label>
        <input 
          type="text" 
          id="accessKey" 
          name="auth_identifier_token"
          placeholder="Digite seu usu√°rio"
          autocomplete="new-password"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          enterkeyhint="next"
          data-lpignore="true"
          required
        >
      </div>

      <div class="form-group">
        <label for="secretKey">Senha</label>
        <div class="password-field">
          <input 
            type="text" 
            id="secretKey" 
            name="auth_secret_token"
            class="masked-secret"
            data-secret-input="true"
            placeholder="Digite sua senha"
            autocomplete="new-password"
            autocorrect="off"
            autocapitalize="none"
            enterkeyhint="go"
            data-lpignore="true"
            required
          >
          <button type="button" class="password-toggle" data-toggle-password="secretKey" aria-label="Mostrar senha" title="Mostrar senha"></button>
        </div>
      </div>

      <button type="submit" class="login-button">Entrar</button>
    </form>

  </div>

  <script src="/config.js"></script>
  <script src="/ui.js"></script>
  <script>
    // Use URLs relativas para evitar problemas de protocolo (http/https) e CORS.
    const API_URL = window.API_BASE || '';

    // Helper para formatar mensagens de erro com detalhes
    function formatErrorMessage(data) {
      if (!data) return 'Erro desconhecido';
      if (data.details && Array.isArray(data.details)) {
        // Remove o prefixo "campo: " de cada mensagem
        return data.details.map(msg => {
          const colonIndex = msg.indexOf(':');
          return colonIndex > 0 ? msg.substring(colonIndex + 1).trim() : msg;
        }).join('; ');
      }
      if (data.details && typeof data.details === 'string') {
        // Remove o prefixo "campo: " se existir
        const colonIndex = data.details.indexOf(':');
        return colonIndex > 0 ? data.details.substring(colonIndex + 1).trim() : data.details;
      }
      return data.error || 'Erro desconhecido';
    }

    function initPasswordToggles() {
      const supportsMaskedText = typeof CSS !== 'undefined'
        && typeof CSS.supports === 'function'
        && (CSS.supports('-webkit-text-security', 'disc') || CSS.supports('text-security', 'disc'));

      const iconShow = `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
      `;

      const iconHide = `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M3 3l18 18"></path>
          <path d="M10.7 10.7a2 2 0 0 0 2.6 2.6"></path>
          <path d="M9.9 5.1A11 11 0 0 1 12 5c6.5 0 10 7 10 7a17.5 17.5 0 0 1-3.2 4.2"></path>
          <path d="M6.2 6.2A17.4 17.4 0 0 0 2 12s3.5 7 10 7c1.8 0 3.5-.5 5-1.3"></path>
        </svg>
      `;

      const setMaskedMode = (input, masked) => {
        if (supportsMaskedText && input.dataset.secretInput === 'true') {
          input.type = 'text';
          input.classList.toggle('masked-secret', masked);
          return;
        }
        input.classList.remove('masked-secret');
        input.type = masked ? 'password' : 'text';
      };

      const isShowing = (input) => {
        if (supportsMaskedText && input.dataset.secretInput === 'true') {
          return !input.classList.contains('masked-secret');
        }
        return input.type === 'text';
      };

      const updateToggle = (btn, input) => {
        const showing = isShowing(input);
        btn.innerHTML = showing ? iconHide : iconShow;
        btn.setAttribute('aria-label', showing ? 'Ocultar senha' : 'Mostrar senha');
        btn.setAttribute('title', showing ? 'Ocultar senha' : 'Mostrar senha');
      };

      document.querySelectorAll('[data-toggle-password]').forEach((btn) => {
        const targetId = btn.getAttribute('data-toggle-password');
        const input = document.getElementById(targetId);
        if (!input) return;

        setMaskedMode(input, true);
        updateToggle(btn, input);
        btn.addEventListener('click', () => {
          const showing = isShowing(input);
          setMaskedMode(input, showing);
          updateToggle(btn, input);
        });
      });
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('accessKey').value;
      const password = document.getElementById('secretKey').value;
      const errorDiv = document.getElementById('errorMessage');
      const loginBtn = document.querySelector('.login-button');

      console.log('[login] Tentando login com:', { username });

      errorDiv.style.display = 'none';
      loginBtn.disabled = true;
      loginBtn.textContent = 'Aguarde...';

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // Importante para cookies de sess√£o
          body: JSON.stringify({ username, password })
        });

        console.log('[login] Resposta do servidor:', response.status);

        const data = await response.json();
        console.log('[login] Dados da resposta:', data);

        if (!response.ok) {
          throw new Error(formatErrorMessage(data) || 'Erro ao fazer login');
        }

        console.log('[login] Login bem-sucedido, redirecionando...');
        // Redirecionamento ser√° determinado pelo backend/session
        if (typeof navigateTo === 'function') navigateTo('/agent'); else window.location.href = '/agent';
      } catch (error) {
        console.error('[login] Erro:', error);
        if (typeof showNotification === 'function') {
          showNotification(error.message, 'error');
        } else {
          errorDiv.textContent = error.message;
          errorDiv.style.display = 'block';
        }
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar';
      }
    }

    // Aguarda o ui.js ser carregado e depois inicializa
    document.addEventListener('DOMContentLoaded', () => {
      initPasswordToggles();

      const secureFields = [
        document.getElementById('accessKey'),
        document.getElementById('secretKey'),
      ].filter(Boolean);

      secureFields.forEach((field) => {
        // Mitiga autofill agressivo de alguns navegadores/gerenciadores.
        field.value = '';
        field.readOnly = true;
        const unlock = () => { field.readOnly = false; };
        field.addEventListener('focus', unlock, { once: true });
        field.addEventListener('pointerdown', unlock, { once: true });
        field.addEventListener('keydown', unlock, { once: true });
      });

      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', () => {
          secureFields.forEach((field) => { field.readOnly = false; });
        });
        loginForm.addEventListener('submit', handleLogin);
      }
      
      // Verifica conex√£o ao abrir a tela
      if (typeof ensureConnected === 'function') {
        ensureConnected().then(result => {
          if (result) {
            document.getElementById('accessKey').focus();
          }
        }).catch(err => console.error('Erro ao verificar conex√£o:', err));
      }
    });
  </script>
</body>
</html>
