#!/bin/bash

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
PID_FILE="$PROJECT_DIR/data/backend.pid"

# Função para mostrar menu
show_menu() {
  echo -e "${BLUE}╔═══════════════════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║        WhatsApp System - Menu de Controle             ║${NC}"
  echo -e "${BLUE}╚═══════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo -e "${YELLOW}1${NC} - Iniciar servidor"
  echo -e "${YELLOW}2${NC} - Parar servidor"
  echo -e "${YELLOW}3${NC} - Reiniciar servidor"
  echo -e "${YELLOW}4${NC} - Ver status"
  echo -e "${YELLOW}5${NC} - Resetar banco de dados"
  echo -e "${YELLOW}6${NC} - Limpar logs"
  echo -e "${YELLOW}0${NC} - Sair"
  echo ""
}

# Função para iniciar
start_server() {
  if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if kill -0 "$PID" 2>/dev/null; then
      echo -e "${RED}✗ Servidor já está rodando (PID: $PID)${NC}"
      return 1
    fi
  fi
  
  echo -e "${GREEN}✓ Iniciando servidor WhatsApp System...${NC}"
  echo ""
  
  cd "$PROJECT_DIR/backend" || exit 1
  # Em LAN/HTTP, 'production' pode ativar headers/cookies (ex: HSTS) que atrapalham acesso por IP.
  # Por padrão usamos development; se você quiser, pode sobrescrever: NODE_ENV=production ./start start
  NODE_ENV="${NODE_ENV:-development}" node index.js &
  
  echo $! > "$PID_FILE"
  sleep 2
  
  echo -e "${GREEN}✓ Servidor iniciado com sucesso!${NC}"
  echo ""
  echo -e "${BLUE}Acesse em:${NC}"
  echo -e "  • Local: http://localhost:3001"
  # Tenta obter IP local de diferentes formas
  LOCAL_IP=$(hostname -I 2>/dev/null | awk '{print $1}')
  if [ -z "$LOCAL_IP" ]; then
    LOCAL_IP=$(ip addr 2>/dev/null | grep "inet " | grep -v "127.0.0.1" | head -1 | awk '{print $2}' | cut -d'/' -f1)
  fi
  if [ -n "$LOCAL_IP" ]; then
    echo -e "  • Rede: http://$LOCAL_IP:3001"
  fi
  echo ""
}

# Função para parar
stop_server() {
  if [ ! -f "$PID_FILE" ]; then
    echo -e "${RED}✗ Nenhum servidor em execução${NC}"
    return 1
  fi
  
  PID=$(cat "$PID_FILE")
  
  if ! kill -0 "$PID" 2>/dev/null; then
    echo -e "${RED}✗ Processo não encontrado (PID: $PID)${NC}"
    rm -f "$PID_FILE"
    return 1
  fi
  
  echo -e "${YELLOW}⋯ Parando servidor (PID: $PID)...${NC}"
  kill "$PID" 2>/dev/null
  
  # Aguarda até 10 segundos para o processo terminar
  for i in {1..10}; do
    if ! kill -0 "$PID" 2>/dev/null; then
      rm -f "$PID_FILE"
      echo -e "${GREEN}✓ Servidor parado com sucesso${NC}"
      return 0
    fi
    sleep 1
  done
  
  # Se ainda estiver rodando, força o encerramento
  echo -e "${YELLOW}⋯ Forçando encerramento...${NC}"
  kill -9 "$PID" 2>/dev/null
  rm -f "$PID_FILE"
  echo -e "${GREEN}✓ Servidor encerrado forçadamente${NC}"
}

# Função para restart
restart_server() {
  echo -e "${YELLOW}⋯ Reiniciando servidor...${NC}"
  stop_server
  sleep 2
  start_server
}

# Função para status
show_status() {
  echo ""
  if [ ! -f "$PID_FILE" ]; then
    echo -e "${RED}● Servidor: DESLIGADO${NC}"
    return 0
  fi
  
  PID=$(cat "$PID_FILE")
  
  if kill -0 "$PID" 2>/dev/null; then
    echo -e "${GREEN}● Servidor: RODANDO${NC}"
    echo -e "  PID: $PID"
    echo -e "  Uptime: $(ps -o etime= -p "$PID" | xargs)"
    echo -e "  Memória: $(ps -o rss= -p "$PID" | awk '{printf "%.1f MB", $1/1024}')"
    echo ""
    echo -e "${BLUE}Acesso:${NC}"
    echo -e "  • Local: http://localhost:3001"
    # Tenta obter IP local de diferentes formas
    LOCAL_IP=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [ -z "$LOCAL_IP" ]; then
      LOCAL_IP=$(ip addr 2>/dev/null | grep "inet " | grep -v "127.0.0.1" | head -1 | awk '{print $2}' | cut -d'/' -f1)
    fi
    if [ -n "$LOCAL_IP" ]; then
      echo -e "  • Rede: http://$LOCAL_IP:3001"
    fi
  else
    echo -e "${RED}● Servidor: PID não encontrado ($PID)${NC}"
    rm -f "$PID_FILE"
  fi
  echo ""
}

# Função para resetar banco
reset_database() {
  echo -e "${RED}⚠ AVISO: Isto irá apagar TODOS os dados do banco!${NC}"
  echo -n "Digite 'sim' para confirmar: "
  read -r confirm
  
  if [ "$confirm" != "sim" ]; then
    echo -e "${YELLOW}✗ Operação cancelada${NC}"
    return 1
  fi
  
  echo -e "${YELLOW}⋯ Resetando banco de dados...${NC}"
  
  stop_server
  sleep 1
  
  cd "$PROJECT_DIR" || exit 1
  bash reset-all.sh
  
  echo -e "${GREEN}✓ Banco de dados resetado${NC}"
}

# Função para limpar logs
clear_logs() {
  echo -e "${YELLOW}⋯ Limpando logs...${NC}"
  
  > "$PROJECT_DIR/server.log"
  
  echo -e "${GREEN}✓ Logs limpos${NC}"
}

# Main loop
if [ $# -eq 0 ]; then
  # Modo interativo
  while true; do
    show_menu
    read -p "Escolha uma opção: " choice
    echo ""
    
    case $choice in
      1) start_server ;;
      2) stop_server ;;
      3) restart_server ;;
      4) show_status ;;
      5) reset_database ;;
      6) clear_logs ;;
      0) echo -e "${GREEN}Até logo!${NC}"; exit 0 ;;
      *) echo -e "${RED}✗ Opção inválida${NC}" ;;
    esac
    
    echo ""
    read -p "Pressione Enter para continuar..."
    clear
  done
else
  # Modo command-line
  case "$1" in
    start)      start_server ;;
    stop)       stop_server ;;
    restart)    restart_server ;;
    status)     show_status ;;
    reset)      reset_database ;;
    logs)       clear_logs ;;
    *)          
      echo "Uso: $0 [comando]"
      echo ""
      echo "Comandos disponíveis:"
      echo "  start       - Iniciar o servidor"
      echo "  stop        - Parar o servidor"
      echo "  restart     - Reiniciar o servidor"
      echo "  status      - Ver status do servidor"
      echo "  reset       - Resetar banco de dados (CUIDADO!)"
      echo "  logs        - Limpar logs"
      echo ""
      echo "Sem argumentos: modo interativo com menu"
      exit 1
      ;;
  esac
fi
