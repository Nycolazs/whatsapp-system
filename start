#!/usr/bin/env bash

set -u

PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
BACKEND_DIR="$PROJECT_DIR/backend"
PID_FILE="$PROJECT_DIR/data/backend.pid"
LOG_FILE="$PROJECT_DIR/server.log"
APP_PORT="${PORT:-${HTTP_PORT:-3001}}"
STARTUP_TIMEOUT="${BACKEND_STARTUP_TIMEOUT:-25}"

mkdir -p "$PROJECT_DIR/data"
touch "$LOG_FILE"

read_pid() {
  if [ -f "$PID_FILE" ]; then
    tr -d '[:space:]' < "$PID_FILE"
  fi
}

is_pid_running() {
  local pid="${1:-}"
  [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null
}

cleanup_stale_pid() {
  local pid
  pid="$(read_pid || true)"
  if [ -n "$pid" ] && ! is_pid_running "$pid"; then
    rm -f "$PID_FILE"
  fi
}

is_running() {
  cleanup_stale_pid
  local pid
  pid="$(read_pid || true)"
  is_pid_running "$pid"
}

wait_for_health() {
  local timeout_s="${1:-25}"
  local deadline=$((SECONDS + timeout_s))

  while [ "$SECONDS" -lt "$deadline" ]; do
    if curl -fsS "http://127.0.0.1:${APP_PORT}/healthz" >/dev/null 2>&1; then
      return 0
    fi
    sleep 1
  done

  return 1
}

start_backend() {
  if is_running; then
    echo "[backend] already running (PID: $(read_pid))"
    return 0
  fi

  echo "[backend] starting..."
  (
    cd "$BACKEND_DIR" || exit 1
    NODE_ENV="${NODE_ENV:-development}" SERVE_FRONTEND="${SERVE_FRONTEND:-0}" nohup node index.js >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
  )

  sleep 1

  local pid
  pid="$(read_pid || true)"
  if ! is_pid_running "$pid"; then
    rm -f "$PID_FILE"
    echo "[backend] failed to start. Check logs: $LOG_FILE"
    return 1
  fi

  if wait_for_health "$STARTUP_TIMEOUT"; then
    echo "[backend] ready at http://localhost:${APP_PORT} (PID: $pid)"
  else
    echo "[backend] running, but health check did not pass in ${STARTUP_TIMEOUT}s"
    echo "[backend] check logs: $LOG_FILE"
  fi
}

stop_backend() {
  if ! is_running; then
    echo "[backend] already stopped"
    rm -f "$PID_FILE"
    return 0
  fi

  local pid
  pid="$(read_pid)"

  echo "[backend] stopping PID $pid..."
  kill "$pid" 2>/dev/null || true

  for _ in {1..15}; do
    if ! is_pid_running "$pid"; then
      rm -f "$PID_FILE"
      echo "[backend] stopped"
      return 0
    fi
    sleep 1
  done

  echo "[backend] forcing shutdown PID $pid..."
  kill -9 "$pid" 2>/dev/null || true
  rm -f "$PID_FILE"
  echo "[backend] stopped (forced)"
}

status_backend() {
  if is_running; then
    local pid
    pid="$(read_pid)"
    local uptime
    uptime="$(ps -o etime= -p "$pid" | xargs 2>/dev/null || true)"
    local mem
    mem="$(ps -o rss= -p "$pid" | awk '{printf "%.1f MB", $1/1024}' 2>/dev/null || true)"

    echo "[backend] running"
    echo "  PID: $pid"
    echo "  Uptime: ${uptime:-unknown}"
    echo "  Memory: ${mem:-unknown}"
    echo "  API: http://localhost:${APP_PORT}"
    echo "  Logs: $LOG_FILE"

    if curl -fsS "http://127.0.0.1:${APP_PORT}/healthz" >/dev/null 2>&1; then
      echo "  Health: ok"
    else
      echo "  Health: unreachable"
    fi
  else
    echo "[backend] stopped"
  fi
}

restart_backend() {
  stop_backend
  start_backend
}

clear_logs() {
  : > "$LOG_FILE"
  echo "[backend] logs cleared: $LOG_FILE"
}

reset_database() {
  echo "This will remove all local data."
  printf "Type 'yes' to continue: "
  read -r confirm
  if [ "$confirm" != "yes" ]; then
    echo "Cancelled"
    return 1
  fi

  stop_backend
  (
    cd "$PROJECT_DIR" || exit 1
    bash ./reset-all.sh
  )
}

usage() {
  cat <<USAGE
Usage: ./start <command>

Commands:
  start      Start backend in background
  stop       Stop backend
  restart    Restart backend
  status     Show backend status
  tail       Tail backend logs
  logs       Clear backend logs
  reset      Reset local data (destructive)
USAGE
}

case "${1:-}" in
  start) start_backend ;;
  stop) stop_backend ;;
  restart) restart_backend ;;
  status) status_backend ;;
  tail) tail -f "$LOG_FILE" ;;
  logs) clear_logs ;;
  reset) reset_database ;;
  *) usage; exit 1 ;;
esac
